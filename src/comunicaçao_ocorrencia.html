<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigação de Ocorrência</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/comunicaçãao_ocorrencia.css">
    <style>
        /* Estilos adicionais para melhorar a aparência dos campos calculados */
        .calculated-field {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button (visível apenas em mobile) -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="app-container">
        <!-- Menu Lateral -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <i class="fas fa-user-circle user-avatar"></i>
                    <div class="user-info">
                        <span class="user-name" id="sidebar-user-name"></span>
                        <span class="user-unit" id="sidebar-user-unit"></span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-menu">
                <ul>
                    <li>
                        <a href="home.html">
                            <i class="fas fa-home"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="old_home.html">
                            <i class="fas fa-gauge"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="documentos.html">
                            <i class="fas fa-file-alt"></i>
                            <span>Documentos</span>
                        </a>
                    </li>
                    <li>
                        <a href="validades.html">
                            <i class="fas fa-calendar-check"></i>
                            <span>Validades</span>
                        </a>
                    </li>
                    <li>
                        <a href="procedimentos_operacionais.html">
                            <i class="fas fa-book"></i>
                            <span>Procedimentos Operacionais</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="comunicacao_ocorrencia.html">
                            <i class="fas fa-bullhorn"></i>
                            <span>Comunicação de Ocorrência</span>
                        </a>
                    </li>
                    <li>
                        <a href="invetigacao.html">
                            <i class="fas fa-search"></i>
                            <span>Investigação de Ocorrência</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <button id="confirm-unit-change" class="btn btn-sm btn-success w-100" style="display: none;">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
            
            <button class="btn btn-danger btn-sm w-100" id="sidebar-logout-btn">
                <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Sair</span>
            </button>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <div class="content-header">
                <h1>Comunicação de Ocorrência</h1>
                <div class="breadcrumb">Formulário • Comunicação</div>
            </div>

            <div class="form-container">
                <form id="investigacaoForm" action="https://formsubmit.co/seu-email@exemplo.com" method="POST">
                    
                    <!-- Seção 1: Informações Gerais -->
                    <div class="form-section">
                        <h3>Informações Gerais</h3>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="unidade" class="form-label">Unidade:</label>
                                    <input type="text" class="form-control" id="unidade" name="unidade" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dataOcorrido" class="form-label">Data do Ocorrido:</label>
                                    <input type="date" class="form-control" id="dataOcorrido" name="dataOcorrido" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="diaSemana" class="form-label">Dia da Semana:</label>
                                    <select class="form-control" id="diaSemana" name="diaSemana" required>
                                        <option value="">Selecione</option>
                                        <option value="Segunda-feira">Segunda-feira</option>
                                        <option value="Terça-feira">Terça-feira</option>
                                        <option value="Quarta-feira">Quarta-feira</option>
                                        <option value="Quinta-feira">Quinta-feira</option>
                                        <option value="Sexta-feira">Sexta-feira</option>
                                        <option value="Sábado">Sábado</option>
                                        <option value="Domingo">Domingo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Reincidente?:</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="radio" id="reincidenteSim" name="reincidente" value="Sim" required>
                                            <label for="reincidenteSim">Sim</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="radio" id="reincidenteNao" name="reincidente" value="Não">
                                            <label for="reincidenteNao">Não</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="nivel" class="form-label">Nível:</label>
                                    <select class="form-control" id="nivel" name="nivel" required>
                                        <option value="">Selecione</option>
                                        <option value="Incidente">Incidente</option>
                                        <option value="Leve">Leve</option>
                                        <option value="Moderado">Moderado</option>
                                        <option value="Grave">Grave</option>
                                        <option value="Gravíssimo">Gravíssimo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Seção 2: Envolvido -->
                    <div class="form-section">
                        <h3>Envolvido</h3>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="nomeEnvolvido" class="form-label">Nome:</label>
                                    <input type="text" class="form-control" id="nomeEnvolvido" name="nomeEnvolvido" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="tipoOcorrencia" class="form-label">Tipo de Ocorrência:</label>
                                    <select class="form-control" id="tipoOcorrencia" name="tipoOcorrencia" required>
                                        <option value="">Selecione</option>
                                        <option value="Típico">Típico</option>
                                        <option value="Trajeto">Trajeto</option>
                                        <option value="Colisão de estrutura">Colisão de Máquina</option>
                                        <option value="Colisão em estrutura">Colisão em estrutura</option>
                                        <option value="Acidente de transito">Acidente de trânsito</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dataNascimento" class="form-label">Data de Nascimento:</label>
                                    <input type="date" class="form-control" id="dataNascimento" name="dataNascimento" required onchange="calcularIdade()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="faixaEtaria" class="form-label">Faixa Etária:</label>
                                    <input type="text" class="form-control calculated-field" id="faixaEtaria" name="faixaEtaria" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="funcao" class="form-label">Função:</label>
                                    <input type="text" class="form-control" id="funcao" name="funcao" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dataAdmissao" class="form-label">Data de Admissão:</label>
                                    <input type="date" class="form-control" id="dataAdmissao" name="dataAdmissao" required onchange="calcularTempoEmpresa()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="tempoEmpresa" class="form-label">Faixa de atuação:</label>
                                    <select class="form-control" id="tempoEmpresa" name="tempoEmpresa" required>
                                        <option value="">Selecione</option>
                                        <option value="0 a 3 meses">0 a 3 meses</option>
                                        <option value="3 a 6 meses">3 a 6 meses</option>
                                        <option value="6 meses a 1 ano">6 meses a 1 ano</option>
                                        <option value="1 a 2 anos">1 a 2 anos</option>
                                        <option value="2 a 5 anos">2 a 5 anos</option>
                                        <option value="5 a 10 anos">5 a 10 anos</option>
                                        <option value="Mais de 10 anos">Mais de 10 anos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="tempoCasa" class="form-label">Tempo de casa:</label>
                                    <input type="text" class="form-control calculated-field" id="tempoCasa" name="tempoCasa" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="diasTrabalhadosFolga" class="form-label">Dias Trabalhados em Relação a última Folga:</label>
                                    <input type="number" class="form-control" id="diasTrabalhadosFolga" name="diasTrabalhadosFolga" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="horasTrabalhadas" class="form-label">Horas Trabalhadas até o Ocorrido:</label>
                                    <input type="number" class="form-control" id="horasTrabalhadas" name="horasTrabalhadas" min="0" step="0.5" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Jornada de Trabalho:</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="radio" id="jornadaNormal" name="jornadaTrabalho" value="Normal" required>
                                            <label for="jornadaNormal">Normal</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="radio" id="jornadaExtra" name="jornadaTrabalho" value="Extra">
                                            <label for="jornadaExtra">Extra</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Tipo de Colaborador:</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="radio" id="colaboradorFixo" name="tipoColaborador" value="Fixo" required>
                                            <label for="colaboradorFixo">Fixo</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="radio" id="colaboradorIntermitente" name="tipoColaborador" value="Intermitente">
                                            <label for="colaboradorIntermitente">Intermitente</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="horario" class="form-label">Horário do Ocorrido:</label>
                                    <input type="time" class="form-control" id="horario" name="horario" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="lesao" class="form-label">Lesão:</label>
                                    <input type="text" class="form-control" id="lesao" name="lesao">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="parteAtingida" class="form-label">Parte Atingida:</label>
                                    <select class="form-control" id="parteAtingida" name="parteAtingida">
                                        <option value="N/A">N/A</option>
                                        <option value="Cabeça">Cabeça</option>
                                        <option value="Couro cabeludo">Couro cabeludo</option>
                                        <option value="Testa">Testa</option>
                                        <option value="Olho Direito">Olho Direito</option>
                                        <option value="Olho Esquerdo">Olho Esquerdo</option>
                                        <option value="Nariz">Nariz</option>
                                        <option value="Boca">Boca</option>
                                        <option value="Dente">Dente</option>
                                        <option value="Língua">Língua</option>
                                        <option value="Orelha Direita">Orelha Direita</option>
                                        <option value="Orelha Esquerda">Orelha Esquerda</option>
                                        <option value="Pescoço">Pescoço</option>
                                        <option value="Ombro Direito">Ombro Direito</option>
                                        <option value="Ombro Esquerdo">Ombro Esquerdo</option>
                                        <option value="Braço Direito">Braço Direito</option>
                                        <option value="Braço Esquerdo">Braço Esquerdo</option>
                                        <option value="Cotovelo Direito">Cotovelo Direito</option>
                                        <option value="Cotovelo Esquerdo">Cotovelo Esquerdo</option>
                                        <option value="Antebraço Direito">Antebraço Direito</option>
                                        <option value="Antebraço Esquerdo">Antebraço Esquerdo</option>
                                        <option value="Pulso Direito">Pulso Direito</option>
                                        <option value="Pulso Esquerdo">Pulso Esquerdo</option>
                                        <option value="Mão Direita">Mão Direita</option>
                                        <option value="Mão Esquerda">Mão Esquerda</option>
                                        <option value="Dedos da Mão Direita">Dedos da Mão Direita</option>
                                        <option value="Dedos da Mão Esquerda">Dedos da Mão Esquerda</option>
                                        <option value="Peito">Peito</option>
                                        <option value="Costas">Costas</option>
                                        <option value="Barriga">Barriga</option>
                                        <option value="Quadril">Quadril</option>
                                        <option value="Glúteo Direito">Glúteo Direito</option>
                                        <option value="Glúteo Esquerdo">Glúteo Esquerdo</option>
                                        <option value="Perna Direita">Perna Direita</option>
                                        <option value="Perna Esquerda">Perna Esquerda</option>
                                        <option value="Coxa Direita">Coxa Direita</option>
                                        <option value="Coxa Esquerda">Coxa Esquerda</option>
                                        <option value="Joelho Direito">Joelho Direito</option>
                                        <option value="Joelho Esquerdo">Joelho Esquerdo</option>
                                        <option value="Panturrilha Direita">Panturrilha Direita</option>
                                        <option value="Panturrilha Esquerda">Panturrilha Esquerda</option>
                                        <option value="Tornozelo Direito">Tornozelo Direito</option>
                                        <option value="Tornozelo Esquerdo">Tornozelo Esquerdo</option>
                                        <option value="Pé Direito">Pé Direito</option>
                                        <option value="Pé Esquerdo">Pé Esquerdo</option>
                                        <option value="Dedos do Pé Direito">Dedos do Pé Direito</option>
                                        <option value="Dedos do Pé Esquerdo">Dedos do Pé Esquerdo</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Seção 3: Descrição da Ocorrência -->
                    <div class="form-section">
                        <h3>Descrição da Ocorrência</h3>
                        <div class="form-group">
                            <textarea class="form-control" id="descricaoOcorrencia" name="descricaoOcorrencia" rows="5" required></textarea>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Seção 4: Fotos da Ocorrência -->
                    <div class="form-section">
                        <h3>Fotos da Ocorrência</h3>
                        <div class="form-group">
                            <label for="fotosOcorrencia" class="form-label">Adicionar Fotos:</label>
                            <input type="file" class="form-control" id="fotosOcorrencia" name="fotosOcorrencia" multiple accept="image/*">
                            <small class="text-muted">Selecione uma ou mais fotos para anexar ao relatório</small>
                        </div>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Seção 5: Condição Típica da Ocorrência -->
                    <div class="form-section">
                        <h3>Condição Típica da Ocorrência</h3>
                        
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="pressa" name="condicaoTipica" value="Pressa">
                                <label for="pressa">Pressa</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="alteracaoEmocional" name="condicaoTipica" value="Alteração emocional">
                                <label for="alteracaoEmocional">Alteração emocional</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="olhosNaTarefa" name="condicaoTipica" value="Olhos na tarefa">
                                <label for="olhosNaTarefa">Olhos na tarefa</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="menteNaTarefa" name="condicaoTipica" value="Mente na tarefa">
                                <label for="menteNaTarefa">Mente na tarefa</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="linhaDeFogo" name="condicaoTipica" value="Linha de fogo">
                                <label for="linhaDeFogo">Linha de fogo</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="zonaDeRisco" name="condicaoTipica" value="Zona de risco">
                                <label for="zonaDeRisco">Zona de risco</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="faltaEquilibrio" name="condicaoTipica" value="Falta de equilíbrio">
                                <label for="faltaEquilibrio">Falta de equilíbrio</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="falhaMaquina" name="condicaoTipica" value="Falha de máquina">
                                <label for="falhaMaquina">Falha de máquina</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="procedimento" name="condicaoTipica" value="Procedimento">
                                <label for="procedimento">Procedimento</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cansaço" name="condicaoTipica" value="Cansaço">
                                <label for="cansaço">Cansaço</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excessoConfianca" name="condicaoTipica" value="Excesso de confiança">
                                <label for="excessoConfianca">Excesso de confiança</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="faltaConhecimento" name="condicaoTipica" value="Falta de conhecimento">
                                <label for="faltaConhecimento">Falta de conhecimento</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="falhaProcesso" name="condicaoTipica" value="Falha de processo">
                                <label for="falhaProcesso">Falha de processo</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="causaTerceiros" name="condicaoTipica" value="Causa de terceiros">
                                <label for="causaTerceiros">Causa de terceiros</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="complacencia" name="condicaoTipica" value="Complacência">
                                <label for="complacencia">Complacência</label>
                            </div>
                        </div>
                    </div>

                    <!-- Nova Seção: Ações Imediatas -->
                    <div class="form-section">
                        <h3>Ações Imediatas</h3>
                        
                        <div class="actions-container">
                            <div class="action-form">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="acaoDescricao" class="form-label">Descrição:</label>
                                            <textarea class="form-control" id="acaoDescricao" rows="3" placeholder="Descreva a ação imediata"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="acaoData" class="form-label">Data:</label>
                                            <input type="date" class="form-control" id="acaoData">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="acaoResponsavel" class="form-label">Responsável:</label>
                                            <input type="text" class="form-control" id="acaoResponsavel" placeholder="Nome do responsável">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="acaoArea" class="form-label">Área:</label>
                                            <input type="text" class="form-control" id="acaoArea" placeholder="Área responsável">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="acaoCargo" class="form-label">Cargo:</label>
                                            <input type="text" class="form-control" id="acaoCargo" placeholder="Cargo do responsável">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-add" id="btnAddAcao">
                                    <i class="fas fa-plus"></i> Adicionar Ação
                                </button>
                            </div>
                            
                            <div class="action-list" id="acoesList">
                                <!-- As ações adicionadas aparecerão aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-submit" id="btnSubmit">
                            <i class="fas fa-paper-plane"></i> Enviar Comunicação
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Comunicação Enviada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Sua Comunicação de ocorrência foi enviada com sucesso e salva no sistema.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Inicialização do Firebase (substitua com suas configurações)
        const firebaseConfig = {
        apiKey: "AIzaSyDZwa4XNqlupNDLs7-CRQbhr5pRT4NyFBA",
        authDomain: "application-gzl.firebaseapp.com",
        databaseURL: "https://application-gzl-default-rtdb.firebaseio.com",
        projectId: "application-gzl",
        storageBucket: "application-gzl.appspot.com",
        messagingSenderId: "319900903265",
        appId: "1:319900903265:web:a8f400aeb7a697fc168720",
        measurementId: "G-ZRRFQZXT54"
        };
        
        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Função para calcular a idade com base na data de nascimento
        function calcularIdade() {
            const dataNascimento = new Date(document.getElementById('dataNascimento').value);
            const hoje = new Date();
            
            if (isNaN(dataNascimento.getTime())) return;
            
            let idade = hoje.getFullYear() - dataNascimento.getFullYear();
            const mesAtual = hoje.getMonth();
            const diaAtual = hoje.getDate();
            const mesNascimento = dataNascimento.getMonth();
            const diaNascimento = dataNascimento.getDate();
            
            if (mesAtual < mesNascimento || (mesAtual === mesNascimento && diaAtual < diaNascimento)) {
                idade--;
            }
            
            let faixaEtaria = "";
            if (idade < 18) faixaEtaria = "Menor de 18 anos";
            else if (idade >= 18 && idade <= 24) faixaEtaria = "18-24 anos";
            else if (idade >= 25 && idade <= 34) faixaEtaria = "25-34 anos";
            else if (idade >= 35 && idade <= 44) faixaEtaria = "35-44 anos";
            else if (idade >= 45 && idade <= 54) faixaEtaria = "45-54 anos";
            else if (idade >= 55 && idade <= 64) faixaEtaria = "55-64 anos";
            else faixaEtaria = "65 anos ou mais";
            
            document.getElementById('faixaEtaria').value = faixaEtaria + ` (${idade} anos)`;
        }
        
        // Função para calcular o tempo de empresa
        function calcularTempoEmpresa() {
            const dataAdmissao = new Date(document.getElementById('dataAdmissao').value);
            const hoje = new Date();
            
            if (isNaN(dataAdmissao.getTime())) return;
            
            // Calcula a diferença em anos, meses e dias
            let anos = hoje.getFullYear() - dataAdmissao.getFullYear();
            let meses = hoje.getMonth() - dataAdmissao.getMonth();
            let dias = hoje.getDate() - dataAdmissao.getDate();
            
            // Ajusta os valores negativos
            if (dias < 0) {
                meses--;
                // Obtém o último dia do mês anterior
                const ultimoDiaMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
                dias += ultimoDiaMesAnterior;
            }
            
            if (meses < 0) {
                anos--;
                meses += 12;
            }
            
            // Formata o resultado
            let tempoCasa = "";
            if (anos > 0) {
                tempoCasa += anos + (anos === 1 ? " ano" : " anos");
            }
            if (meses > 0) {
                if (tempoCasa !== "") tempoCasa += ", ";
                tempoCasa += meses + (meses === 1 ? " mês" : " meses");
            }
            if (dias > 0 || (anos === 0 && meses === 0)) {
                if (tempoCasa !== "") tempoCasa += " e ";
                tempoCasa += dias + (dias === 1 ? " dia" : " dias");
            }
            
            document.getElementById('tempoCasa').value = tempoCasa;
            
            // Atualiza também a faixa de atuação
            const diffTime = Math.abs(hoje - dataAdmissao);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffMonths / 12);
            
            let tempoEmpresa = "";
            if (diffDays < 90) tempoEmpresa = "0 a 3 meses";
            else if (diffDays >= 90 && diffDays < 180) tempoEmpresa = "3 a 6 meses";
            else if (diffDays >= 180 && diffDays < 365) tempoEmpresa = "6 meses a 1 ano";
            else if (diffYears >= 1 && diffYears < 2) tempoEmpresa = "1 a 2 anos";
            else if (diffYears >= 2 && diffYears < 5) tempoEmpresa = "2 a 5 anos";
            else if (diffYears >= 5 && diffYears < 10) tempoEmpresa = "5 a 10 anos";
            else tempoEmpresa = "Mais de 10 anos";
            
            document.getElementById('tempoEmpresa').value = tempoEmpresa;
        }
        
        // Função para gerar ID único
        function generateUniqueId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const randomNum = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            return `${year}${month}${day}${randomNum}`;
        }
        
        // Inicialização quando o documento estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Preenche automaticamente a unidade se o usuário estiver logado
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    firebase.firestore().collection('users').doc(user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                document.getElementById('unidade').value = userData.unit || '';
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao buscar unidade:", error);
                        });
                }
            });

            // Manipulação de fotos
            const photoInput = document.getElementById('fotosOcorrencia');
            const photoPreview = document.getElementById('photoPreview');
            const fotosBase64 = [];
            
            photoInput.addEventListener('change', function(e) {
                const files = e.target.files;
                photoPreview.innerHTML = '';
                fotosBase64.length = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-preview-item';
                        photoDiv.innerHTML = `
                            <img src="${event.target.result}" alt="Preview">
                            <button type="button" class="remove-photo" data-index="${i}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        photoPreview.appendChild(photoDiv);
                        
                        // Adiciona evento de remoção
                        photoDiv.querySelector('.remove-photo').addEventListener('click', function() {
                            photoDiv.remove();
                            fotosBase64.splice(i, 1);
                        });
                        
                        // Armazena a imagem como base64
                        fotosBase64.push(event.target.result.split(',')[1]);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });

            // Gerenciamento de Ações Imediatas
            const acoesList = document.getElementById('acoesList');
            const acoes = [];
            
            document.getElementById('btnAddAcao').addEventListener('click', function() {
                const descricao = document.getElementById('acaoDescricao').value;
                const data = document.getElementById('acaoData').value;
                const responsavel = document.getElementById('acaoResponsavel').value;
                const area = document.getElementById('acaoArea').value;
                const cargo = document.getElementById('acaoCargo').value;
                
                if (!descricao || !data || !responsavel || !area || !cargo) {
                    alert('Por favor, preencha todos os campos da ação.');
                    return;
                }
                
                // Cria um ID único para a ação
                const acaoId = Date.now().toString();
                
                // Adiciona a ação à lista
                acoes.push({
                    id: acaoId,
                    descricao: descricao,
                    data: data,
                    responsavel: responsavel,
                    area: area,
                    cargo: cargo
                });
                
                // Atualiza a visualização
                renderAcoes();
                
                // Limpa os campos do formulário
                document.getElementById('acaoDescricao').value = '';
                document.getElementById('acaoData').value = '';
                document.getElementById('acaoResponsavel').value = '';
                document.getElementById('acaoArea').value = '';
                document.getElementById('acaoCargo').value = '';
            });
            
            function renderAcoes() {
                acoesList.innerHTML = '';
                
                acoes.forEach(acao => {
                    const acaoElement = document.createElement('div');
                    acaoElement.className = 'action-card';
                    acaoElement.innerHTML = `
                        <div class="action-card-header">
                            <h4 class="action-title">Ação</h4>
                            <button type="button" class="btn-remove remove-acao" data-id="${acao.id}">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>
                        <div class="action-details">
                            <p><strong>Descrição:</strong> ${acao.descricao}</p>
                        </div>
                        <div class="action-meta">
                            <span><i class="fas fa-calendar"></i> <strong>Data:</strong> ${formatDate(acao.data)}</span>
                            <span><i class="fas fa-user"></i> <strong>Responsável:</strong> ${acao.responsavel}</span>
                            <span><i class="fas fa-building"></i> <strong>Área:</strong> ${acao.area}</span>
                            <span><i class="fas fa-briefcase"></i> <strong>Cargo:</strong> ${acao.cargo}</span>
                        </div>
                    `;
                    acoesList.appendChild(acaoElement);
                });
                
                // Adiciona eventos de remoção
                document.querySelectorAll('.remove-acao').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const index = acoes.findIndex(a => a.id === id);
                        if (index !== -1) {
                            acoes.splice(index, 1);
                            renderAcoes();
                        }
                    });
                });
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            }

            // Envio do formulário
            document.getElementById('investigacaoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('btnSubmit');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

                // Gera ID único para a investigação
                const investigacaoId = generateUniqueId();

                // Coleta todos os dados do formulário
                const formData = new FormData(this);
                const investigacaoData = {
                    id: investigacaoId,
                    unidade: formData.get('unidade'),
                    dataOcorrido: formData.get('dataOcorrido'),
                    diaSemana: formData.get('diaSemana'),
                    reincidente: formData.get('reincidente'),
                    nivel: formData.get('nivel'),
                    nomeEnvolvido: formData.get('nomeEnvolvido'),
                    tipoOcorrencia: formData.get('tipoOcorrencia'),
                    dataNascimento: formData.get('dataNascimento'),
                    faixaEtaria: formData.get('faixaEtaria'),
                    funcao: formData.get('funcao'),
                    dataAdmissao: formData.get('dataAdmissao'),
                    tempoEmpresa: formData.get('tempoEmpresa'),
                    tempoCasa: document.getElementById('tempoCasa').value,
                    diasTrabalhadosFolga: formData.get('diasTrabalhadosFolga'),
                    horasTrabalhadas: formData.get('horasTrabalhadas'),
                    jornadaTrabalho: formData.get('jornadaTrabalho'),
                    tipoColaborador: formData.get('tipoColaborador'),
                    lesao: formData.get('lesao'),
                    parteAtingida: formData.get('parteAtingida'),
                    horario: formData.get('horario'),
                    descricaoOcorrencia: formData.get('descricaoOcorrencia'),
                    condicaoTipica: Array.from(document.querySelectorAll('input[name="condicaoTipica"]:checked')).map(el => el.value),
                    acoesImediatas: acoes,
                    fotos: fotosBase64,
                    userId: firebase.auth().currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Salva no Firestore
                firebase.firestore().collection('investigacoes').doc(investigacaoId).set(investigacaoData)
                    .then(() => {
                        console.log('Documento salvo com ID:', investigacaoId);
                        
                        // Envia o email via FormSubmit
                        fetch('https://formsubmit.co/ajax/seu-email@exemplo.com', {
                            method: 'POST',
                            body: new FormData(document.getElementById('investigacaoForm'))
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Mostra modal de confirmação
                            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                            modal.show();
                            
                            // Limpa o formulário
                            document.getElementById('investigacaoForm').reset();
                            document.getElementById('photoPreview').innerHTML = '';
                            acoes.length = 0;
                            renderAcoes();
                        })
                        .catch(error => {
                            console.error('Erro ao enviar email:', error);
                            alert('Ocorreu um erro ao enviar o email, mas os dados foram salvos.');
                        });
                    })
                    .catch((error) => {
                        console.error('Erro ao salvar documento:', error);
                        alert('Ocorreu um erro ao salvar a investigação. Por favor, tente novamente.');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Investigação';
                    });
            });
        });
    </script>
    <script src="../js/hamb.js"></script>
</body>
</html>