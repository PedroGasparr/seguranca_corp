<!--VERSION 3.8-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Validades</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/validade.css">
    <link rel="icon" href="../img/engenheiro.png" type="image/x-icon">
    <style>
        /* Estilos adicionais para a nova funcionalidade */
        .documentos-obrigatorios {
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .documento-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .documento-item:last-child {
            border-bottom: none;
        }
        
        .documento-item:hover {
            background-color: #f9f9f9;
        }
        
        .documento-item.pendente:hover {
            background-color: #fff3cd;
        }
        
        .documento-item.nao-aplicavel:hover {
            background-color: #e2e8f0;
        }
        
        .documento-info {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .documento-acoes {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }
        
        .documento-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }
        
        .status-enviado {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-pendente {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-nao-aplicavel {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .documento-nome {
            font-weight: 500;
            flex-grow: 1;
        }
        
        .card-unidade {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .card-unidade:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .unidade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .contador-documentos {
            font-size: 14px;
            color: #6c757d;
        }
        
        .progresso-documentos {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progresso-bar {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Estilos para os botões de ação */
        .document-actions {
            display: none;
            justify-content: flex-start;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .btn-delete {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }
        
        .btn-delete:hover {
            background-color: #c82333 !important;
            border-color: #bd2130 !important;
        }
        
        #selected-count {
            margin-left: auto;
            font-weight: bold;
            color: #495057;
        }
        
        .text-warning {
            color: #ffc107 !important;
            margin-left: 5px;
        }
        
        /* Estilo para linhas selecionadas */
        tr.selected {
            background-color: #e8f4ff !important;
        }
        
        tr.selected:hover {
            background-color: #d9edff !important;
        }
        
        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .confirmation-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .confirmation-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .confirmation-content h3 {
            color: #dc3545;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .confirmation-content .warning-text {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .confirmation-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn-reverter {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
            padding: 2px 8px !important;
            font-size: 11px !important;
        }
        
        .btn-reverter:hover {
            background-color: #5a6268 !important;
            border-color: #545b62 !important;
        }
        
        .btn-sm {
            padding: 3px 10px !important;
            font-size: 12px !important;
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button (visível apenas em mobile) -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="app-container">
        <!-- Menu Lateral -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <i class="fas fa-user-circle user-avatar"></i>
                    <div class="user-info">
                        <span class="user-name" id="sidebar-user-name">Carregando...</span>
                        <span class="user-unit" id="sidebar-user-unit">Carregando...</span>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-menu">
                <ul>
                    <li>
                        <a href="home.html">
                            <i class="fas fa-home"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="old_home.html">
                            <i class="fas fa-gauge"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="documentos.html">
                            <i class="fas fa-file-alt"></i>
                            <span>Documentos</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="validades.html">
                            <i class="fas fa-calendar-check"></i>
                            <span>Validades</span>
                        </a>
                    </li>
                    <li>
                        <a href="procedimentos_operacionais.html">
                            <i class="fas fa-book"></i>
                            <span>Procedimentos Operacionais</span>
                        </a>
                    </li>
                    <li>
                        <a href="comunicaçao_ocorrencia.html">
                            <i class="fas fa-bullhorn"></i>
                            <span>Comunicação de Ocorrencia</span>
                        </a>
                    </li>
                    <li>
                        <a href="invetigacao.html">
                            <i class="fas fa-search"></i>
                            <span>Investigação de Ocorrencia</span>
                        </a>
                    </li>
                    <li>
                        <a class="active" href="relato_desvio.html">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Relatos de Desvio</span>
                        </a>
                    </li>
                    <li>
                        <a href="historicoRD.html">
                            <i class="fas fa-history"></i>
                            <span>Histórico de Relatos</span>
                        </a>
                    </li>
                    <li >
                        <a href="padrinho.html">
                            <i class="fas fa-handshake"></i>
                            <span>Cadastro de Apadrinhamento</span>
                        </a>
                    </li>
                    <li >
                        <a href="Controle_padrinho.html">
                            <i class="fas fa-face-smile"></i>
                            <span>Visualização de Apadrinhamento</span>
                        </a>
                    </li>
                    <li>
                        <a href="visualizar-padrinhos.html">
                            <i class="fas fa-qrcode"></i>
                            <span>Leitor QR Code</span>
                        </a>
                    </li>
                    <li>
                        <a href="google_forms.html" >
                            <i class="fab fa-google"></i>
                            <span>Formulários Google</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-danger btn-sm" id="sidebar-logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <header class="content-header">
                <h1>Controle de Validades</h1>
                <div class="breadcrumb">
                    <a href="home.html">Home</a> / <span>Validades</span>
                </div>
            </header>

            <div class="content-body">
                <!-- Visão para unidades comuns -->
                <div id="unit-view" class="card" style="display: none;">
                    <button id="back-to-corp" class="back-button" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Voltar para todas as unidades
                    </button>
                    <div class="card-header">
                        <h2><i class="fas fa-building"></i> <span id="unit-name-title">Minha Unidade</span></h2>
                        <div class="search-box">
                            <input type="text" id="document-search" placeholder="Pesquisar documentos...">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    
                    <!-- Lista de documentos obrigatórios -->
                    <div class="documentos-obrigatorios" id="documentos-obrigatorios-list">
                        <h3>Documentos Obrigatórios</h3>
                        <div class="empty-row">Carregando documentos obrigatórios...</div>
                    </div>
                    
                    <div class="status-summary">
                        <div class="status-item">
                            <span class="status-label">Conformes</span>
                            <span class="status-value conforme" id="conforme-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">A vencer em 45 dias</span>
                            <span class="status-value a-vencer" id="a-vencer-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Vencidos</span>
                            <span class="status-value vencido" id="vencido-count">0</span>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="documents-table" class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-docs" title="Selecionar todos"></th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Validade</th>
                                    <th>Dias Restantes</th>
                                    <th>Status</th>
                                    <th>Documento</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="empty-row">
                                    <td colspan="7">Carregando documentos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Painel de ações para documentos selecionados -->
                    <div class="document-actions" id="docs-actions">
                        <button class="btn btn-danger" id="move-to-disable-btn">
                            <i class="fas fa-archive"></i> Mover para Documentos Desativados
                        </button>
                        <button class="btn btn-danger btn-delete" id="delete-documents-btn">
                            <i class="fas fa-trash"></i> Excluir Permanentemente
                        </button>
                        <span id="selected-count">0 selecionados</span>
                    </div>
                </div>
                
                <!-- Visão para Gestão Corp (cards das unidades) -->
                <div id="corp-view" class="dashboard-container" style="display: none;">
                    <!-- Cards serão gerados dinamicamente pelo JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para visualização de documentos da unidade -->
    <div class="modal" id="unit-documents-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-unit-name">Documentos da Unidade</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Lista de documentos obrigatórios no modal -->
                <div class="documentos-obrigatorios" id="modal-documentos-obrigatorios-list">
                    <h3>Documentos Obrigatórios</h3>
                    <div class="empty-row">Carregando documentos obrigatórios...</div>
                </div>
                
                <div class="status-summary">
                    <div class="status-item">
                        <span class="status-label">Conformes</span>
                        <span class="status-value conforme" id="modal-conforme-count">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">A vencer em 45 dias</span>
                        <span class="status-value a-vencer" id="modal-a-vencer-count">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Vencidos</span>
                        <span class="status-value vencido" id="modal-vencido-count">0</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="modal-documents-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Validade</th>
                                <th>Dias Restantes</th>
                                <th>Status</th>
                                <th>Documento</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="empty-row">
                                <td colspan="6">Carregando documentos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="send-email-btn">
                    <i class="fas fa-envelope"></i> Enviar Alerta por Email
                </button>
                <button class="btn btn-secondary modal-close">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para envio de email -->
    <div class="modal" id="email-modal">
        <div class="email-modal-content">
            <h3><i class="fas fa-envelope"></i> Enviar Alerta de Documentos</h3>
            
            <div class="form-group">
                <label>Unidade: <strong id="email-unit-name"></strong></label>
            </div>
            
            <div class="form-group">
                <label>Documentos Vencidos/Próximos do Vencimento:</label>
                <div id="email-documents-list" class="document-list"></div>
            </div>
            
            <div class="form-group">
                <label>Destinatários:</label>
                <div id="email-recipients" class="email-recipients"></div>
            </div>
            
            <div class="form-group">
                <label for="email-subject">Assunto:</label>
                <input type="text" id="email-subject" class="form-control" value="Alerta de Documentos Pendentes">
            </div>
            
            <div class="form-group">
                <label for="email-message">Mensagem:</label>
                <textarea id="email-message" class="form-control" rows="5">
Prezados,

Identificamos que os seguintes documentos da unidade estão vencidos ou próximos do vencimento:

[LISTA_DE_DOCUMENTOS]

Por favor, regularize a situação o mais breve possível.

Atenciosamente,
Gestão Corporativa
                </textarea>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancel-email-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-primary" id="confirm-send-email-btn">
                    <i class="fas fa-paper-plane"></i> Enviar Email
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação para exclusão -->
    <div class="confirmation-modal" id="delete-confirmation-modal">
        <div class="confirmation-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmação de Exclusão</h3>
            <p>Você está prestes a excluir <strong id="delete-count">0</strong> documento(s) permanentemente.</p>
            
            <div class="warning-text">
                <strong><i class="fas fa-exclamation-circle"></i> ATENÇÃO: Esta ação é irreversível!</strong>
                <p style="margin: 5px 0 0 0; font-size: 14px;">
                    • Os documentos serão removidos do banco de dados<br>
                    • Não será possível recuperá-los<br>
                    • Esta ação será registrada no log do sistema
                </p>
            </div>
            
            <p>Digite <strong>"EXCLUIR"</strong> no campo abaixo para confirmar:</p>
            <input type="text" id="confirmation-input" class="form-control" placeholder="Digite EXCLUIR aqui..." style="margin-top: 10px;">
            
            <div class="confirmation-actions">
                <button class="btn btn-secondary" id="cancel-delete-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-danger" id="confirm-delete-btn" disabled>
                    <i class="fas fa-trash"></i> Confirmar Exclusão
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/hamb.js"></script>
    <script>
        // Variáveis globais
        let currentUser = null;
        let currentUnitId = null;
        let allUnits = [];
        let allDocuments = [];
        let selectedUnitId = null;
        let isViewingAsUnit = false;
        let selectedDocuments = [];
        let naoObrigatoriosData = {};
        let documentosNaoObrigatoriosIds = {}; // Para armazenar IDs dos registros
        
        // Lista de documentos obrigatórios
        const DOCUMENTOS_OBRIGATORIOS = [
            { value: 'PCMSO', label: 'PCMSO' },
            { value: 'PGR', label: 'PGR' },
            { value: 'PCA', label: 'PCA' },
            { value: 'AET', label: 'AET' },
            { value: 'PERICULOSIDADE', label: 'PERICULOSIDADE' },
            { value: 'INSALUBRIDADE', label: 'INSALUBRIDADE' },
            { value: 'LTCAT', label: 'LTCAT' },
            { value: 'PPR', label: 'PPR' },
            { value: 'CIPA_PROCESSO_ELEITORAL', label: 'CIPA PROCESSO ELEITORAL' },
            { value: 'CIPA_REUNIAO_MENSAL', label: 'CIPA REUNIAO MENSAL' },
            { value: 'BRIGADA_DE_INCÊNDIO', label: 'BRIGADA DE INCÊNDIO' }
        ];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged(async function(user) {
                if (user) {
                    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            displayName: userData.name || user.email,
                            unidade: userData.unit || 'Não definida',
                            unidadeId: userData.unitId || userData.unit
                        };
                        
                        // Atualiza a sidebar
                        document.getElementById('sidebar-user-name').textContent = currentUser.displayName;
                        document.getElementById('sidebar-user-unit').textContent = currentUser.unidade;
                        
                        // Carrega dados de documentos não obrigatórios
                        await loadNaoObrigatorios();
                        
                        // Carrega unidades (para gestão corp)
                        if (currentUser.unidade.toLowerCase() === 'gestão corp') {
                            await loadAllUnits();
                            showCorpView();
                        } else {
                            currentUnitId = currentUser.unidadeId;
                            showUnitView(currentUnitId);
                        }
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });

            // Event listeners
            document.getElementById('sidebar-logout-btn')?.addEventListener('click', logoutUser);
            document.getElementById('send-email-btn')?.addEventListener('click', showEmailModal);
            document.getElementById('cancel-email-btn')?.addEventListener('click', () => {
                document.getElementById('email-modal').classList.remove('modal-open');
            });
            document.getElementById('confirm-send-email-btn')?.addEventListener('click', sendEmailAlert);
            document.getElementById('back-to-corp')?.addEventListener('click', backToCorpView);
            
            // Event listeners para modal de exclusão
            document.getElementById('cancel-delete-btn')?.addEventListener('click', () => {
                document.getElementById('delete-confirmation-modal').style.display = 'none';
                document.getElementById('confirmation-input').value = '';
                document.getElementById('confirm-delete-btn').disabled = true;
            });
            
            document.getElementById('confirmation-input')?.addEventListener('input', function(e) {
                const confirmBtn = document.getElementById('confirm-delete-btn');
                if (e.target.value.toUpperCase() === 'EXCLUIR') {
                    confirmBtn.disabled = false;
                } else {
                    confirmBtn.disabled = true;
                }
            });
            
            document.getElementById('confirm-delete-btn')?.addEventListener('click', deleteDocumentsPermanently);
            
            // Fechar modais
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('unit-documents-modal').classList.remove('modal-open');
                    document.getElementById('email-modal').classList.remove('modal-open');
                });
            });
            
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('unit-documents-modal')) {
                    document.getElementById('unit-documents-modal').classList.remove('modal-open');
                }
                if (e.target === document.getElementById('email-modal')) {
                    document.getElementById('email-modal').classList.remove('modal-open');
                }
                if (e.target === document.getElementById('delete-confirmation-modal')) {
                    document.getElementById('delete-confirmation-modal').style.display = 'none';
                    document.getElementById('confirmation-input').value = '';
                    document.getElementById('confirm-delete-btn').disabled = true;
                }
            });

            // Inicializar seleção de documentos
            initDocumentSelection();
        });

        // Carregar dados de documentos não obrigatórios
        async function loadNaoObrigatorios() {
            try {
                const snapshot = await firebase.firestore().collection('nao_obrigatorios').get();
                naoObrigatoriosData = {};
                documentosNaoObrigatoriosIds = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!naoObrigatoriosData[data.unidadeId]) {
                        naoObrigatoriosData[data.unidadeId] = {};
                        documentosNaoObrigatoriosIds[data.unidadeId] = {};
                    }
                    naoObrigatoriosData[data.unidadeId][data.tipo] = true;
                    documentosNaoObrigatoriosIds[data.unidadeId][data.tipo] = doc.id;
                });
            } catch (error) {
                console.error("Erro ao carregar documentos não obrigatórios:", error);
                naoObrigatoriosData = {};
                documentosNaoObrigatoriosIds = {};
            }
        }

        // Verificar se um documento é não obrigatório para uma unidade
        function isNaoObrigatorio(unidadeId, tipo) {
            return naoObrigatoriosData[unidadeId] && naoObrigatoriosData[unidadeId][tipo];
        }

        // Mostrar visão para unidades comuns
        async function showUnitView(unitId, unitName = null, isFromCorpView = false) {
            document.getElementById('unit-view').style.display = 'block';
            document.getElementById('corp-view').style.display = 'none';
            
            if (isFromCorpView) {
                isViewingAsUnit = true;
                document.getElementById('back-to-corp').style.display = 'block';
                
                // Atualiza a sidebar temporariamente para mostrar a unidade selecionada
                document.getElementById('sidebar-user-unit').textContent = unitName || 'Visualizando Unidade';
            } else {
                isViewingAsUnit = false;
                document.getElementById('back-to-corp').style.display = 'none';
            }
            
            const unitNameToShow = unitName || currentUser.unidade;
            document.getElementById('unit-name-title').textContent = unitNameToShow;
            
            await loadUnitDocuments(unitId);
            await updateDocumentosObrigatorios(unitId);
        }

        // Voltar para a visão corporativa
        function backToCorpView() {
            isViewingAsUnit = false;
            document.getElementById('back-to-corp').style.display = 'none';
            
            // Restaura a sidebar para mostrar o usuário real
            document.getElementById('sidebar-user-unit').textContent = currentUser.unidade;
            
            showCorpView();
        }

        // Mostrar visão para gestão corp
        async function showCorpView() {
            document.getElementById('unit-view').style.display = 'none';
            document.getElementById('corp-view').style.display = 'flex';
            
            const corpView = document.getElementById('corp-view');
            corpView.innerHTML = '';
            
            // Adiciona um loader enquanto carrega
            corpView.innerHTML = '<div class="loading">Carregando unidades...</div>';
            
            try {
                // Garante que os dados estão carregados
                if (allUnits.length === 0) {
                    await loadAllUnits();
                }
                
                corpView.innerHTML = ''; // Limpa o loader
                
                for (const unit of allUnits) {
                    if (unit.id === 'gestão corp') continue;
                    
                    const unitDocs = allDocuments.filter(doc => doc.unidadeId === unit.id);
                    
                    // Verificar documentos obrigatórios
                    const documentosStatus = await verificarDocumentosObrigatorios(unit.id);
                    const documentosEnviados = documentosStatus.filter(doc => doc.enviado).length;
                    const documentosNaoAplicaveis = documentosStatus.filter(doc => doc.naoAplicavel).length;
                    const totalDocumentos = documentosStatus.length - documentosNaoAplicaveis;
                    
                    // Contadores atualizados com o novo status
                    const conformeCount = unitDocs.filter(doc => doc.status === 'conforme').length;
                    const aVencerCount = unitDocs.filter(doc => doc.status === 'a-vencer').length;
                    const vencidoCount = unitDocs.filter(doc => doc.status === 'vencido').length;
                    
                    // Pegar os 2 documentos mais vencidos para mostrar no card
                    const vencidos = unitDocs.filter(doc => doc.status === 'vencido')
                                            .sort((a, b) => a.daysLeft - b.daysLeft)
                                            .slice(0, 2);
                    
                    const card = document.createElement('div');
                    card.className = 'unit-card card-unidade';
                    card.setAttribute('data-unit-id', unit.id);
                    card.setAttribute('data-unit-name', unit.name);
                    
                    card.innerHTML = `
                        <div class="unidade-header">
                            <h3>${unit.name}</h3>
                            <span class="contador-documentos">${documentosEnviados}/${totalDocumentos}</span>
                        </div>
                        <div class="progresso-documentos">
                            <div class="progresso-bar" style="width: ${totalDocumentos > 0 ? (documentosEnviados/totalDocumentos)*100 : 0}%"></div>
                        </div>
                        <div class="status-count">
                            <div class="status-item">
                                <div class="status-value conforme">${conformeCount}</div>
                                <div>Conformes</div>
                            </div>
                            <div class="status-item">
                                <div class="status-value a-vencer">${aVencerCount}</div>
                                <div>A vencer</div>
                            </div>
                            <div class="status-item">
                                <div class="status-value vencido">${vencidoCount}</div>
                                <div>Vencidos</div>
                            </div>
                        </div>
                        <div class="document-list">
                            ${vencidos.map(doc => `
                                <div class="document-item vencido">
                                    <div>${doc.nome}</div>
                                    <div class="days-left negative-days">
                                        Venceu há ${Math.abs(doc.daysLeft)} dias
                                    </div>
                                </div>
                            `).join('')}
                            ${vencidoCount > 2 ? `<div>+ ${vencidoCount - 2} mais vencidos...</div>` : ''}
                        </div>
                        <button class="btn-view-docs" data-unit-id="${unit.id}" data-unit-name="${unit.name}">
                            <i class="fas fa-eye"></i> Ver Documentos
                        </button>
                    `;
                    
                    corpView.appendChild(card);
                }

                // Event delegation para os cards
                corpView.addEventListener('click', function(e) {
                    const card = e.target.closest('.unit-card');
                    const btn = e.target.closest('.btn-view-docs');
                    
                    if (card && !btn) {
                        // Clicou no card inteiro (exceto no botão)
                        const unitId = card.getAttribute('data-unit-id');
                        const unitName = card.getAttribute('data-unit-name');
                        showUnitView(unitId, unitName, true);
                    } else if (btn) {
                        // Clicou no botão "Ver Documentos"
                        const unitId = btn.getAttribute('data-unit-id');
                        const unitName = btn.getAttribute('data-unit-name');
                        showUnitDocumentsModal(unitId, unitName);
                    }
                });

            } catch (error) {
                console.error('Erro ao mostrar visão corporativa:', error);
                corpView.innerHTML = '<div class="error">Erro ao carregar unidades. Tente recarregar a página.</div>';
            }
        }

        // Carregar todas as unidades
        async function loadAllUnits() {
            try {
                const docsSnapshot = await firebase.firestore().collection('documentos').get();
                
                allDocuments = docsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const validadeDate = data.validade.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const daysLeft = Math.ceil((validadeDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    
                    // Determinar status com base nos dias restantes
                    let status;
                    if (daysLeft < 0) {
                        status = 'vencido';
                    } else if (daysLeft <= 45) {
                        status = 'a-vencer';
                    } else {
                        status = 'conforme';
                    }
                    
                    return {
                        id: doc.id,
                        ...data,
                        validadeDate,
                        daysLeft,
                        status
                    };
                });

                const unidadesMap = new Map();
                allDocuments.forEach(doc => {
                    if (doc.unidadeId) {
                        unidadesMap.set(doc.unidadeId, doc.unidade || doc.unidadeId);
                    }
                });

                allUnits = Array.from(unidadesMap, ([id, name]) => ({ id, name }));
            } catch (error) {
                console.error("Erro ao carregar unidades:", error);
                allUnits = [];
                allDocuments = [];
            }
        }

        // Verificar documentos obrigatórios de uma unidade
        async function verificarDocumentosObrigatorios(unitId) {
            const resultados = [];
            
            for (const doc of DOCUMENTOS_OBRIGATORIOS) {
                // Verificar se o documento foi marcado como não aplicável
                const naoAplicavel = isNaoObrigatorio(unitId, doc.value);
                
                if (!naoAplicavel) {
                    const querySnapshot = await firebase.firestore().collection('documentos')
                        .where('unidadeId', '==', unitId)
                        .where('tipo', '==', doc.value)
                        .get();
                    
                    resultados.push({
                        tipo: doc.value,
                        label: doc.label,
                        enviado: !querySnapshot.empty,
                        naoAplicavel: false,
                        documentos: querySnapshot.docs.map(d => d.data())
                    });
                } else {
                    resultados.push({
                        tipo: doc.value,
                        label: doc.label,
                        enviado: false,
                        naoAplicavel: true,
                        documentos: []
                    });
                }
            }
            
            return resultados;
        }

        // Atualizar a lista de documentos obrigatórios na interface
        async function updateDocumentosObrigatorios(unitId) {
            const container = document.getElementById('documentos-obrigatorios-list');
            container.innerHTML = '<h3>Documentos Obrigatórios</h3><div class="empty-row">Carregando...</div>';
            
            try {
                const documentosStatus = await verificarDocumentosObrigatorios(unitId);
                const enviadosCount = documentosStatus.filter(doc => doc.enviado && !doc.naoAplicavel).length;
                const naoAplicaveisCount = documentosStatus.filter(doc => doc.naoAplicavel).length;
                const totalCount = documentosStatus.length - naoAplicaveisCount;
                
                let html = `
                    <h3>Documentos Obrigatórios (${enviadosCount}/${totalCount})</h3>
                    <div class="progresso-documentos">
                        <div class="progresso-bar" style="width: ${totalCount > 0 ? (enviadosCount/totalCount)*100 : 0}%"></div>
                    </div>
                `;
                
                documentosStatus.forEach(doc => {
                    let statusClass = 'status-pendente';
                    let statusText = 'Pendente';
                    let acoesHTML = '';
                    
                    if (doc.naoAplicavel) {
                        statusClass = 'status-nao-aplicavel';
                        statusText = 'Não Aplicável';
                        // Botão para reverter quando é não aplicável
                        acoesHTML = `
                            <div class="documento-acoes">
                                <button class="btn btn-reverter btn-sm" data-tipo="${doc.tipo}" title="Reverter para pendente">
                                    <i class="fas fa-undo"></i> Reverter
                                </button>
                            </div>
                        `;
                    } else if (doc.enviado) {
                        statusClass = 'status-enviado';
                        statusText = 'Enviado';
                    } else {
                        // Botão para marcar como não aplicável quando está pendente
                        acoesHTML = `
                            <div class="documento-acoes">
                                <button class="btn btn-warning btn-sm" data-tipo="${doc.tipo}" title="Marcar como não aplicável">
                                    <i class="fas fa-ban"></i> Não Aplicável
                                </button>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="documento-item ${doc.naoAplicavel ? 'nao-aplicavel' : (doc.enviado ? '' : 'pendente')}" data-tipo="${doc.tipo}">
                            <div class="documento-info">
                                <div class="documento-nome">${doc.label}</div>
                                ${acoesHTML}
                            </div>
                            <span class="documento-status ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Adicionar event listeners para botões
                container.addEventListener('click', function(e) {
                    const naoAplicavelBtn = e.target.closest('.btn-warning');
                    const reverterBtn = e.target.closest('.btn-reverter');
                    
                    if (naoAplicavelBtn) {
                        const tipo = naoAplicavelBtn.getAttribute('data-tipo');
                        marcarComoNaoAplicavel(unitId, tipo);
                    }
                    
                    if (reverterBtn) {
                        const tipo = reverterBtn.getAttribute('data-tipo');
                        reverterParaPendente(unitId, tipo);
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar documentos obrigatórios:', error);
                container.innerHTML = '<div class="error">Erro ao carregar documentos obrigatórios</div>';
            }
        }

        // Marcar documento como não aplicável
        async function marcarComoNaoAplicavel(unitId, tipo) {
            if (!confirm(`Tem certeza que deseja marcar este documento como "Não Aplicável" para esta unidade?\n\nDocumento: ${getTipoText(tipo)}`)) {
                return;
            }
            
            try {
                // Salvar no Firestore
                const docRef = await firebase.firestore().collection('nao_obrigatorios').add({
                    unidadeId: unitId,
                    tipo: tipo,
                    marcadoPor: currentUser.displayName,
                    marcadoPorEmail: currentUser.email,
                    marcadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Atualizar dados locais
                if (!naoObrigatoriosData[unitId]) {
                    naoObrigatoriosData[unitId] = {};
                    documentosNaoObrigatoriosIds[unitId] = {};
                }
                naoObrigatoriosData[unitId][tipo] = true;
                documentosNaoObrigatoriosIds[unitId][tipo] = docRef.id;
                
                // Atualizar a interface
                await updateDocumentosObrigatorios(unitId);
                
                // Se estiver na visão corporativa, atualizar também
                if (currentUser.unidade.toLowerCase() === 'gestão corp') {
                    showCorpView();
                }
                
                showAlert(`✅ Documento marcado como "Não Aplicável" com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao marcar documento como não aplicável:', error);
                showAlert(`❌ Erro ao marcar documento: ${error.message}`, 'danger');
            }
        }

        // Reverter documento de "Não Aplicável" para pendente
        async function reverterParaPendente(unitId, tipo) {
            if (!confirm(`Tem certeza que deseja reverter este documento para "Pendente"?\n\nDocumento: ${getTipoText(tipo)}`)) {
                return;
            }
            
            try {
                // Verificar se temos o ID do registro
                if (!documentosNaoObrigatoriosIds[unitId] || !documentosNaoObrigatoriosIds[unitId][tipo]) {
                    showAlert('❌ Erro: ID do registro não encontrado.', 'danger');
                    return;
                }
                
                const docId = documentosNaoObrigatoriosIds[unitId][tipo];
                
                // Remover do Firestore
                await firebase.firestore().collection('nao_obrigatorios').doc(docId).delete();
                
                // Atualizar dados locais
                if (naoObrigatoriosData[unitId]) {
                    delete naoObrigatoriosData[unitId][tipo];
                }
                if (documentosNaoObrigatoriosIds[unitId]) {
                    delete documentosNaoObrigatoriosIds[unitId][tipo];
                }
                
                // Atualizar a interface
                await updateDocumentosObrigatorios(unitId);
                
                // Se estiver na visão corporativa, atualizar também
                if (currentUser.unidade.toLowerCase() === 'gestão corp') {
                    showCorpView();
                }
                
                showAlert(`✅ Documento revertido para "Pendente" com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao reverter documento:', error);
                showAlert(`❌ Erro ao reverter documento: ${error.message}`, 'danger');
            }
        }

        // Mostrar modal de documentos da unidade
        async function showUnitDocumentsModal(unitId, unitName) {
            selectedUnitId = unitId;
            const modal = document.getElementById('unit-documents-modal');
            const modalTitle = document.getElementById('modal-unit-name');
            
            modalTitle.textContent = `Documentos - ${unitName}`;
            
            try {
                // Atualizar documentos obrigatórios no modal
                await updateModalDocumentosObrigatorios(unitId);
                
                const querySnapshot = await firebase.firestore().collection('documentos')
                    .where('unidadeId', '==', unitId)
                    .get();
                
                const unitDocs = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    const validadeDate = data.validade.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const daysLeft = Math.ceil((validadeDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    
                    // Determina o status baseado nos dias restantes
                    let status;
                    if (daysLeft < 0) {
                        status = 'vencido';
                    } else if (daysLeft <= 45) {
                        status = 'a-vencer';
                    } else {
                        status = 'conforme';
                    }
                    
                    return {
                        id: doc.id,
                        ...data,
                        validadeDate,
                        daysLeft,
                        status,
                        arquivoBase64: data.arquivoBase64 || '',
                        arquivoTipo: data.arquivoTipo || 'application/pdf',
                        arquivoNome: data.arquivoNome || 'documento.pdf'
                    };
                });

                // Atualiza contadores com a nova lógica
                document.getElementById('modal-conforme-count').textContent = 
                    unitDocs.filter(doc => doc.status === 'conforme').length;
                document.getElementById('modal-a-vencer-count').textContent = 
                    unitDocs.filter(doc => doc.status === 'a-vencer').length;
                document.getElementById('modal-vencido-count').textContent = 
                    unitDocs.filter(doc => doc.status === 'vencido').length;
                
                // Atualiza tabela no modal
                const tbody = document.querySelector('#modal-documents-table tbody');
                tbody.innerHTML = unitDocs.map(doc => `
                    <tr class="${doc.status}">
                        <td>${doc.nome}</td>
                        <td>${getTipoText(doc.tipo)}</td>
                        <td>${doc.validadeDate.toLocaleDateString('pt-BR')}</td>
                        <td class="days-left ${getDaysLeftClass(doc.daysLeft)}">
                            ${formatDaysLeft(doc.daysLeft)}
                        </td>
                        <td><span class="status-badge ${doc.status}">${getStatusText(doc.status)}</span></td>
                        <td>
                            ${doc.arquivoBase64 ? 
                                `<a href="${createPreviewUrl(doc.arquivoBase64, doc.arquivoTipo)}" 
                                target="_blank" 
                                class="btn btn-info btn-sm" 
                                download="${doc.arquivoNome}">
                                    <i class="fas fa-download"></i>
                                </a>` : 
                                'N/A'}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6">Nenhum documento encontrado</td></tr>';
                
                // Mostra o modal usando a classe modal-open
                modal.classList.add('modal-open');
            } catch (error) {
                console.error('Erro ao carregar documentos:', error);
                showAlert('❌ Erro ao carregar documentos da unidade', 'danger');
            }
        }

        // Atualizar documentos obrigatórios no modal
        async function updateModalDocumentosObrigatorios(unitId) {
            const container = document.getElementById('modal-documentos-obrigatorios-list');
            container.innerHTML = '<h3>Documentos Obrigatórios</h3><div class="empty-row">Carregando...</div>';
            
            try {
                const documentosStatus = await verificarDocumentosObrigatorios(unitId);
                const enviadosCount = documentosStatus.filter(doc => doc.enviado && !doc.naoAplicavel).length;
                const naoAplicaveisCount = documentosStatus.filter(doc => doc.naoAplicavel).length;
                const totalCount = documentosStatus.length - naoAplicaveisCount;
                
                let html = `
                    <h3>Documentos Obrigatórios (${enviadosCount}/${totalCount})</h3>
                    <div class="progresso-documentos">
                        <div class="progresso-bar" style="width: ${totalCount > 0 ? (enviadosCount/totalCount)*100 : 0}%"></div>
                    </div>
                `;
                
                documentosStatus.forEach(doc => {
                    let statusClass = 'status-pendente';
                    let statusText = 'Pendente';
                    let acoesHTML = '';
                    
                    if (doc.naoAplicavel) {
                        statusClass = 'status-nao-aplicavel';
                        statusText = 'Não Aplicável';
                        acoesHTML = `
                            <div class="documento-acoes">
                                <button class="btn btn-reverter btn-sm" data-tipo="${doc.tipo}" title="Reverter para pendente">
                                    <i class="fas fa-undo"></i> Reverter
                                </button>
                            </div>
                        `;
                    } else if (doc.enviado) {
                        statusClass = 'status-enviado';
                        statusText = 'Enviado';
                    } else {
                        acoesHTML = `
                            <div class="documento-acoes">
                                <button class="btn btn-warning btn-sm" data-tipo="${doc.tipo}" title="Marcar como não aplicável">
                                    <i class="fas fa-ban"></i> Não Aplicável
                                </button>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="documento-item ${doc.naoAplicavel ? 'nao-aplicavel' : (doc.enviado ? '' : 'pendente')}" data-tipo="${doc.tipo}">
                            <div class="documento-info">
                                <div class="documento-nome">${doc.label}</div>
                                ${acoesHTML}
                            </div>
                            <span class="documento-status ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Adicionar event listeners para botões no modal
                container.addEventListener('click', function(e) {
                    const naoAplicavelBtn = e.target.closest('.btn-warning');
                    const reverterBtn = e.target.closest('.btn-reverter');
                    
                    if (naoAplicavelBtn) {
                        const tipo = naoAplicavelBtn.getAttribute('data-tipo');
                        marcarComoNaoAplicavel(unitId, tipo);
                    }
                    
                    if (reverterBtn) {
                        const tipo = reverterBtn.getAttribute('data-tipo');
                        reverterParaPendente(unitId, tipo);
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar documentos obrigatórios:', error);
                container.innerHTML = '<div class="error">Erro ao carregar documentos obrigatórios</div>';
            }
        }

        // Carregar documentos de uma unidade específica
        async function loadUnitDocuments(unitId) {
            let query = firebase.firestore().collection('documentos');
            query = query.where('unidadeId', '==', unitId);
            
            const snapshot = await query.get();
            const documents = snapshot.docs.map(doc => {
                const data = doc.data();
                const validadeDate = data.validade.toDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const timeDiff = validadeDate.getTime() - today.getTime();
                const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                // Determinar status com base nos dias restantes
                let status;
                if (daysLeft < 0) {
                    status = 'vencido';
                } else if (daysLeft <= 45) {
                    status = 'a-vencer';
                } else {
                    status = 'conforme';
                }
                
                return {
                    id: doc.id,
                    ...data,
                    validadeDate,
                    daysLeft,
                    status,
                    arquivoBase64: data.arquivoBase64 || '',
                    arquivoTipo: data.arquivoTipo || 'application/pdf',
                    arquivoNome: data.arquivoNome || 'documento.pdf'
                };
            });
            
            updateUnitDocumentsTable(documents);
        }

        // Atualizar tabela de documentos da unidade
        function updateUnitDocumentsTable(documents) {
            const tbody = document.querySelector('#documents-table tbody');
            
            // Nova lógica: conforme, a vencer em 45 dias, vencido
            const conformeCount = documents.filter(doc => doc.status === 'conforme').length;
            const aVencerCount = documents.filter(doc => doc.status === 'a-vencer').length;
            const vencidoCount = documents.filter(doc => doc.status === 'vencido').length;
            
            document.getElementById('conforme-count').textContent = conformeCount;
            document.getElementById('a-vencer-count').textContent = aVencerCount;
            document.getElementById('vencido-count').textContent = vencidoCount;
            
            if (documents.length === 0) {
                tbody.innerHTML = '<tr class="empty-row"><td colspan="7">Nenhum documento encontrado</td></tr>';
                return;
            }
            
            documents.sort((a, b) => a.daysLeft - b.daysLeft);
            
            tbody.innerHTML = documents.map(doc => {
                return `
                    <tr class="${doc.status}">
                        <td>
                            <input type="checkbox" class="doc-checkbox" data-doc-id="${doc.id}">
                        </td>
                        <td>${doc.nome}</td>
                        <td>${getTipoText(doc.tipo)}</td>
                        <td>${doc.validadeDate.toLocaleDateString('pt-BR')}</td>
                        <td class="days-left ${getDaysLeftClass(doc.daysLeft)}">
                            ${formatDaysLeft(doc.daysLeft)}
                        </td>
                        <td><span class="status-badge ${doc.status}">${getStatusText(doc.status)}</span></td>
                        <td>
                            <a href="${createPreviewUrl(doc.arquivoBase64, doc.arquivoTipo)}" 
                            target="_blank" 
                            class="btn btn-info btn-sm" 
                            download="${doc.arquivoNome}">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Inicializa a seleção de documentos
            initDocumentSelection();
        }

        // Mostrar modal de envio de email
        async function showEmailModal() {
            if (!selectedUnitId) return;
            
            const unit = allUnits.find(u => u.id === selectedUnitId);
            if (!unit) return;
            
            const unitDocs = allDocuments.filter(doc => 
                doc.unidadeId === selectedUnitId && 
                (doc.status === 'vencido' || doc.status === 'a-vencer')
            );
            
            if (unitDocs.length === 0) {
                alert('Não há documentos vencidos ou próximos do vencimento nesta unidade.');
                return;
            }
            
            const usersSnapshot = await firebase.firestore().collection('users')
                .where('unitId', '==', selectedUnitId)
                .get();
            
            const recipients = usersSnapshot.docs.map(doc => {
                const userData = doc.data();
                return {
                    email: userData.email,
                    name: userData.name || userData.email
                };
            });
            
            if (recipients.length === 0) {
                alert('Não há usuários cadastrados nesta unidade para enviar o email.');
                return;
            }
            
            document.getElementById('email-unit-name').textContent = unit.name;
            
            const docsList = document.getElementById('email-documents-list');
            docsList.innerHTML = unitDocs.map(doc => `
                <div class="document-item ${doc.status}">
                    <strong>${doc.nome}</strong> - 
                    ${doc.validadeDate.toLocaleDateString('pt-BR')} 
                    (${formatDaysLeft(doc.daysLeft)})
                </div>
            `).join('');
            
            const recipientsList = document.getElementById('email-recipients');
            recipientsList.innerHTML = recipients.map(user => `
                <div class="email-recipient">
                    <i class="fas fa-user"></i> ${user.name} &lt;${user.email}&gt;
                </div>
            `).join('');
            
            const emailMessage = document.getElementById('email-message');
            const documentsText = unitDocs.map(doc => 
                `- ${doc.nome} (Vencimento: ${doc.validadeDate.toLocaleDateString('pt-BR')} - ${formatDaysLeft(doc.daysLeft)})`
            ).join('\n');
            
            emailMessage.value = emailMessage.value.replace('[LISTA_DE_DOCUMENTOS]', documentsText);
            
            document.getElementById('email-modal').classList.add('modal-open');
        }

        // Enviar email de alerta
        async function sendEmailAlert() {
            if (!selectedUnitId) return;
            
            const unit = allUnits.find(u => u.id === selectedUnitId);
            if (!unit) return;
            
            const subject = document.getElementById('email-subject').value;
            const message = document.getElementById('email-message').value;
            
            const usersSnapshot = await firebase.firestore().collection('users')
                .where('unitId', '==', selectedUnitId)
                .get();
            
            const recipients = usersSnapshot.docs.map(doc => doc.data().email);
            
            if (recipients.length === 0) {
                alert('Não há destinatários para enviar o email.');
                return;
            }
            
            try {
                const btn = document.getElementById('confirm-send-email-btn');
                const originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                
                const sendEmail = firebase.functions().httpsCallable('sendDocumentAlertEmail');
                await sendEmail({
                    recipients,
                    subject,
                    message,
                    unitName: unit.name
                });
                
                showAlert('✅ Email enviado com sucesso para os responsáveis da unidade!', 'success');
                document.getElementById('email-modal').classList.remove('modal-open');
            } catch (error) {
                console.error('Erro ao enviar email:', error);
                showAlert(`❌ Erro ao enviar email: ${error.message}`, 'danger');
            } finally {
                const btn = document.getElementById('confirm-send-email-btn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Email';
            }
        }

        // Funções auxiliares
        function getTipoText(tipo) {
            const tipos = {
                'PCMSO': 'PCMSO',
                'PGR': 'PGR',
                'PCA': 'PCA',
                'AET': 'AET',
                'PERICULOSIDADE': 'PERICULOSIDADE',
                'INSALUBRIDADE': 'INSALUBRIDADE',
                'LTCAT': 'LTCAT',
                'PPR': 'PPR',
                'CIPA_PROCESSO_ELEITORAL': 'CIPA PROCESSO ELEITORAL',
                'CIPA_REUNIAO_MENSAL': 'CIPA REUNIAO MENSAL',
                'BRIGADA_DE_INCÊNDIO': 'BRIGADA DE INCÊNDIO',
                'certificado': 'Certificado',
                'contrato': 'Contrato',
                'licenca': 'Licença',
                'procedimento': 'Procedimento',
                'outro': 'Outro'
            };
            return tipos[tipo] || tipo;
        }

        function getStatusText(status) {
            const statusMap = {
                'conforme': 'Conforme',
                'a-vencer': 'A vencer em 45 dias',
                'vencido': 'Vencido',
                'nao_aplicavel': 'Não Aplicável'
            };
            return statusMap[status] || status;
        }

        function formatDaysLeft(days) {
            if (days === 0) return 'Vence hoje';
            if (days < 0) return `Venceu há ${Math.abs(days)} dias`;
            return `${days} dias`;
        }

        function getDaysLeftClass(days) {
            if (days < 0) return 'negative-days';
            if (days <= 45) return 'warning-days';
            return 'positive-days';
        }

        function createPreviewUrl(base64, type) {
            if (!base64) return '#';
            if (base64.startsWith('data:')) return base64;
            return `data:${type};base64,${base64}`;
        }

        // Logout
        function logoutUser() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Erro ao fazer logout:', error);
                showAlert('❌ Erro ao fazer logout', 'danger');
            });
        }

        function initDocumentSelection() {
            // Evento para selecionar/deselecionar todos
            document.getElementById('select-all-docs')?.addEventListener('change', function(e) {
                const checkboxes = document.querySelectorAll('.doc-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                    // Atualiza visualmente o estado de seleção da linha
                    const row = checkbox.closest('tr');
                    if (checkbox.checked) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                });
                updateSelectedDocuments();
            });

            // Event delegation para checkboxes individuais
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('doc-checkbox')) {
                    const row = e.target.closest('tr');
                    if (e.target.checked) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                    updateSelectedDocuments();
                }
            });

            // Botão para mover documentos desativados
            document.getElementById('move-to-disable-btn')?.addEventListener('click', moveToDisableCollection);
            
            // Botão para excluir permanentemente
            document.getElementById('delete-documents-btn')?.addEventListener('click', showDeleteConfirmationModal);
        }

        /**
         * Mostra o modal de confirmação para exclusão
         */
        function showDeleteConfirmationModal() {
            if (selectedDocuments.length === 0) {
                showAlert('❌ Selecione pelo menos um documento para excluir.', 'warning');
                return;
            }
            
            // Mostra o modal de confirmação
            document.getElementById('delete-count').textContent = selectedDocuments.length;
            document.getElementById('delete-confirmation-modal').style.display = 'block';
            document.getElementById('confirmation-input').value = '';
            document.getElementById('confirm-delete-btn').disabled = true;
            document.getElementById('confirmation-input').focus();
        }

        /**
         * Atualiza a lista de documentos selecionados e o painel de ações
         */
        function updateSelectedDocuments() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            selectedDocuments = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-doc-id'));
            
            const actionsPanel = document.getElementById('docs-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (selectedDocuments.length > 0) {
                actionsPanel.style.display = 'flex';
                selectedCount.textContent = `${selectedDocuments.length} selecionado(s)`;
                
                // Verifica se há documentos vencidos selecionados
                const hasExpiredDocs = checkExpiredDocumentsStatus();
                
                // Só habilita mover para desativados se houver vencidos
                document.getElementById('move-to-disable-btn').disabled = !hasExpiredDocs;
                
                // Para exclusão, sempre habilita (pode excluir qualquer documento)
                document.getElementById('delete-documents-btn').disabled = false;
                
                if (!hasExpiredDocs && selectedDocuments.length > 0) {
                    selectedCount.innerHTML += '<span class="text-warning"> (Mover: apenas vencidos)</span>';
                }
            } else {
                actionsPanel.style.display = 'none';
            }
            
            // Desmarca o "selecionar todos" se não estiverem todos selecionados
            const totalCheckboxes = document.querySelectorAll('.doc-checkbox').length;
            const selectAll = document.getElementById('select-all-docs');
            if (selectAll) {
                selectAll.checked = selectedDocuments.length === totalCheckboxes && totalCheckboxes > 0;
                selectAll.indeterminate = selectedDocuments.length > 0 && selectedDocuments.length < totalCheckboxes;
            }
        }

        /**
         * Verifica se há documentos vencidos entre os selecionados
         * @returns {boolean} True se há documentos vencidos selecionados
         */
        function checkExpiredDocumentsStatus() {
            const rows = document.querySelectorAll('#documents-table tbody tr');
            let hasExpired = false;
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.doc-checkbox');
                if (checkbox && checkbox.checked) {
                    const daysLeftCell = row.querySelector('.days-left');
                    if (daysLeftCell && daysLeftCell.classList.contains('negative-days')) {
                        hasExpired = true;
                    }
                }
            });
            
            return hasExpired;
        }

        /**
         * Move os documentos selecionados para a coleção de desativados
         */
        async function moveToDisableCollection() {
            if (selectedDocuments.length === 0) return;
            
            // Confirmação do usuário
            const confirmMove = confirm(`Tem certeza que deseja mover ${selectedDocuments.length} documento(s) para a coleção de desativados?\n\nEsta ação não pode ser desfeita.`);
            if (!confirmMove) return;
            
            try {
                // Mostrar loading
                const btn = document.getElementById('move-to-disable-btn');
                const originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Movendo...';
                
                // Mover cada documento selecionado
                const db = firebase.firestore();
                const batch = db.batch();
                
                // Primeiro, verificar quais documentos estão vencidos
                const docsToMove = [];
                const docsSnapshot = await db.collection('documentos')
                    .where(firebase.firestore.FieldPath.documentId(), 'in', selectedDocuments)
                    .get();
                    
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                docsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const validadeDate = data.validade.toDate();
                    const daysLeft = Math.ceil((validadeDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    
                    if (daysLeft < 0) { // Só move se estiver vencido
                        docsToMove.push({ 
                            id: doc.id, 
                            data: data,
                            daysLeft: daysLeft
                        });
                    }
                });
                
                if (docsToMove.length === 0) {
                    showAlert('❌ Nenhum dos documentos selecionados está vencido. Apenas documentos vencidos podem ser movidos para desativados.', 'warning');
                    resetButtonState(btn, originalBtnText);
                    return;
                }
                
                // Criar documentos na nova coleção e deletar da antiga
                const disableCollection = db.collection('documentosDisable');
                
                for (const doc of docsToMove) {
                    // Adicionar metadados de desativação
                    const docData = {
                        ...doc.data,
                        desativadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                        desativadoPor: currentUser.displayName,
                        desativadoPorEmail: currentUser.email,
                        desativadoPorId: currentUser.uid,
                        statusOriginal: doc.data.status,
                        diasAtraso: Math.abs(doc.daysLeft),
                        motivoDesativacao: "Vencimento automático"
                    };
                    
                    // Adicionar à nova coleção
                    batch.set(disableCollection.doc(doc.id), docData);
                    
                    // Remover da coleção original
                    batch.delete(db.collection('documentos').doc(doc.id));
                }
                
                // Executar a operação em lote
                await batch.commit();
                
                // Feedback visual
                showAlert(`✅ ${docsToMove.length} documento(s) vencido(s) foram movidos para a coleção de desativados com sucesso!`, 'success');
                
                // Recarregar os documentos
                if (isViewingAsUnit) {
                    await loadUnitDocuments(selectedUnitId);
                    await updateDocumentosObrigatorios(selectedUnitId);
                } else if (currentUser.unidade.toLowerCase() === 'gestão corp') {
                    await loadAllUnits();
                    showCorpView();
                } else {
                    await loadUnitDocuments(currentUnitId);
                    await updateDocumentosObrigatorios(currentUnitId);
                }
                
            } catch (error) {
                console.error('Erro ao mover documentos:', error);
                showAlert(`❌ Ocorreu um erro ao mover os documentos: ${error.message}`, 'danger');
            } finally {
                // Resetar seleção
                resetDocumentSelection();
            }
        }

        /**
         * Exclui permanentemente os documentos selecionados
         */
        async function deleteDocumentsPermanently() {
            if (selectedDocuments.length === 0) return;
            
            try {
                // Fechar modal
                document.getElementById('delete-confirmation-modal').style.display = 'none';
                
                // Mostrar loading
                showAlert(`<i class="fas fa-spinner fa-spin"></i> Excluindo ${selectedDocuments.length} documento(s)...`, 'info');
                
                // Excluir cada documento selecionado
                const db = firebase.firestore();
                const batch = db.batch();
                
                // Coletar informações dos documentos antes de excluir
                const docsSnapshot = await db.collection('documentos')
                    .where(firebase.firestore.FieldPath.documentId(), 'in', selectedDocuments)
                    .get();
                
                // Verificar quais documentos podem ser excluídos
                const docsToDelete = [];
                const excludedDocs = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                docsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const validadeDate = data.validade.toDate();
                    const daysLeft = Math.ceil((validadeDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    
                    // Pode excluir qualquer documento (não precisa estar vencido)
                    docsToDelete.push({
                        id: doc.id,
                        data: data,
                        daysLeft: daysLeft
                    });
                });
                
                if (docsToDelete.length === 0) {
                    showAlert('❌ Nenhum documento encontrado para excluir.', 'warning');
                    resetDocumentSelection();
                    return;
                }
                
                // Criar log de exclusões
                const deletionLogs = [];
                
                for (const doc of docsToDelete) {
                    // Adicionar operação de exclusão ao batch
                    batch.delete(db.collection('documentos').doc(doc.id));
                    
                    // Registrar em log
                    deletionLogs.push({
                        id: doc.id,
                        nome: doc.data.nome,
                        tipo: doc.data.tipo,
                        unidade: doc.data.unidade,
                        unidadeId: doc.data.unidadeId,
                        excluidoPor: currentUser.displayName,
                        excluidoPorEmail: currentUser.email,
                        excluidoPorId: currentUser.uid,
                        excluidoEm: firebase.firestore.FieldValue.serverTimestamp(),
                        validade: doc.data.validade,
                        diasRestantes: doc.daysLeft,
                        arquivoNome: doc.data.arquivoNome || 'Não informado',
                        status: doc.daysLeft < 0 ? 'Vencido' : (doc.daysLeft <= 45 ? 'A vencer' : 'Conforme')
                    });
                }
                
                // Salvar logs de exclusões (opcional - remova o comentário se quiser ativar)
                /*
                const logPromises = deletionLogs.map(log => 
                    db.collection('documentosDeletionLog').add(log)
                );
                await Promise.all(logPromises);
                */
                
                // Executar a operação em lote
                await batch.commit();
                
                // Feedback visual
                let successMessage = `<strong>✅ ${docsToDelete.length} documento(s) foram excluídos permanentemente!</strong><br>`;
                successMessage += `<small>Ação concluída com sucesso.</small>`;
                
                showAlert(successMessage, 'success');
                
                // Recarregar os documentos
                if (isViewingAsUnit) {
                    await loadUnitDocuments(selectedUnitId);
                    await updateDocumentosObrigatorios(selectedUnitId);
                } else if (currentUser.unidade.toLowerCase() === 'gestão corp') {
                    await loadAllUnits();
                    showCorpView();
                } else {
                    await loadUnitDocuments(currentUnitId);
                    await updateDocumentosObrigatorios(currentUnitId);
                }
                
            } catch (error) {
                console.error('Erro ao excluir documentos:', error);
                showAlert(`❌ Erro ao excluir documentos: ${error.message}`, 'danger');
            } finally {
                // Resetar input de confirmação
                document.getElementById('confirmation-input').value = '';
                document.getElementById('confirm-delete-btn').disabled = true;
                
                // Resetar seleção
                resetDocumentSelection();
            }
        }

        /**
         * Mostra um alerta na tela
         * @param {string} message - Mensagem a ser exibida
         * @param {string} type - Tipo do alerta (success, danger, warning, info)
         */
        function showAlert(message, type = 'info') {
            // Remove alertas anteriores
            const existingAlerts = document.querySelectorAll('.custom-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert alert alert-${type}`;
            alertDiv.innerHTML = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '2000';
            alertDiv.style.maxWidth = '500px';
            alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            alertDiv.style.animation = 'fadeIn 0.5s, fadeOut 0.5s 4.5s forwards';
            
            document.body.appendChild(alertDiv);
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
            
            // Adicionar botão de fechar
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '10px';
            closeBtn.style.top = '10px';
            closeBtn.style.background = 'none';
            closeBtn.style.border = 'none';
            closeBtn.style.fontSize = '20px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.color = 'inherit';
            closeBtn.addEventListener('click', () => alertDiv.remove());
            
            alertDiv.style.paddingRight = '30px';
            alertDiv.appendChild(closeBtn);
        }

        /**
         * Reseta o estado do botão
         * @param {HTMLElement} button - Elemento do botão
         * @param {string} originalText - Texto original do botão
         */
        function resetButtonState(button, originalText) {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        /**
         * Reseta a seleção de documentos
         */
        function resetDocumentSelection() {
            selectedDocuments = [];
            document.querySelectorAll('.doc-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                const row = checkbox.closest('tr');
                row?.classList.remove('selected');
            });
            
            const selectAll = document.getElementById('select-all-docs');
            if (selectAll) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }
            
            document.getElementById('docs-actions').style.display = 'none';
        }
    </script>
</body>
</html>