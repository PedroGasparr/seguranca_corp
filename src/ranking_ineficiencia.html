<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Desempenho - Pontos Perdidos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== RESET E CONFIGURAÇÕES GERAIS ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: #333;
    min-height: 100vh;
    line-height: 1.6;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
}

/* ===== OVERLAY DE LOGIN ===== */
.login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.3s ease;
}

.login-overlay .text-center {
    background: white;
    padding: 3rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.login-overlay .spinner-border {
    width: 4rem;
    height: 4rem;
    border-width: 0.3em;
}

.login-overlay p {
    font-size: 1.2rem;
    color: #555;
    margin-top: 1.5rem;
    font-weight: 500;
}

/* ===== LAYOUT PRINCIPAL ===== */
#appContent {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 24px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== HEADER ===== */
.dashboard-header {
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    color: white;
    padding: 2rem 2.5rem;
    border-radius: 0 0 20px 20px;
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.dashboard-header h1 i {
    font-size: 1.8rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 12px;
    border-radius: 12px;
    margin-right: 15px;
}

.dashboard-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    max-width: 800px;
}

/* ===== CARDS DE FILTROS ===== */
.filter-card {
    background: #f8fafc;
    border-radius: 16px;
    padding: 1.8rem;
    margin-bottom: 2rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.filter-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
}

.filter-card .form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.filter-card .form-select {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    height: 48px;
}

.filter-card .form-select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.filter-card #btnFiltrar {
    height: 48px;
    border-radius: 10px;
    font-weight: 600;
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.filter-card #btnFiltrar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}

/* ===== CARDS DE MÉTRICAS ===== */
.metric-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    height: 100%;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2ecc71);
    border-radius: 5px 0 0 5px;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
}

.metric-card h6 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-card h2, .metric-card h4 {
    font-weight: 700;
    color: #1e293b;
    margin: 0.5rem 0;
    font-size: 2.2rem;
}

.metric-card h4 {
    font-size: 1.8rem;
}

.metric-card .progress-custom {
    height: 8px;
    border-radius: 10px;
    background-color: #f1f5f9;
    overflow: hidden;
}

.metric-card .progress-custom .progress-bar {
    border-radius: 10px;
    transition: width 1s ease-in-out;
}

/* ===== CARDS DE EVOLUÇÃO ===== */
.evolution-card {
    background: white;
    border-radius: 16px;
    padding: 1.8rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease;
}

.evolution-card:hover {
    transform: translateY(-3px);
}

.evolution-card h5 {
    font-weight: 600;
    color: #1e293b;
    display: flex;
    align-items: center;
    font-size: 1.3rem;
}

.evolution-card h5 i {
    font-size: 1.2rem;
    margin-right: 10px;
    background: rgba(52, 152, 219, 0.1);
    padding: 10px;
    border-radius: 10px;
}

.sidebar{
    display: none;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    margin-top: 1.5rem;
}

/* ===== TABELA DE PERDAS ===== */
.losses-table {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
}

.losses-table .p-3 {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-bottom: 2px solid #3498db;
}

.losses-table h5 {
    font-weight: 600;
    color: #1e293b;
    display: flex;
    align-items: center;
    font-size: 1.3rem;
}

.losses-table h5 i {
    margin-right: 10px;
    background: rgba(241, 196, 15, 0.1);
    padding: 10px;
    border-radius: 10px;
}

.losses-table table {
    margin-bottom: 0;
}

.losses-table thead {
    background: #f1f5f9;
}

.losses-table th {
    font-weight: 600;
    color: #475569;
    font-size: 0.9rem;
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #e2e8f0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.losses-table td {
    padding: 1.2rem 1.5rem;
    vertical-align: middle;
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s ease;
}

.losses-table tbody tr:hover {
    background-color: #f8fafc;
}

.losses-table .category-badge {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.badge-operacional {
    background: rgba(52, 152, 219, 0.1);
    color: #2980b9;
    border: 1px solid rgba(52, 152, 219, 0.2);
}

.badge-documental {
    background: rgba(155, 89, 182, 0.1);
    color: #8e44ad;
    border: 1px solid rgba(155, 89, 182, 0.2);
}

.badge-ocorrencia {
    background: rgba(241, 196, 15, 0.1);
    color: #f39c12;
    border: 1px solid rgba(241, 196, 15, 0.2);
}

.badge-deflator {
    background: rgba(46, 204, 113, 0.1);
    color: #27ae60;
    border: 1px solid rgba(46, 204, 113, 0.2);
}

/* ===== INDICADORES DE TENDÊNCIA ===== */
.trend-up {
    color: #27ae60;
    font-weight: 600;
}

.trend-down {
    color: #e74c3c;
    font-weight: 600;
}

.trend-stable {
    color: #f39c12;
    font-weight: 600;
}

/* ===== ÁREAS DE MELHORIA ===== */
.loss-item {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    height: 100%;
    border-left: 4px solid #3498db;
    transition: all 0.3s ease;
}

.loss-item:hover {
    transform: translateX(5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.loss-high {
    border-left-color: #e74c3c;
}

.loss-medium {
    border-left-color: #f39c12;
}

.loss-low {
    border-left-color: #27ae60;
}

.loss-item h6 {
    font-weight: 600;
    color: #1e293b;
    font-size: 1.1rem;
}

/* ===== ACORDEÃO MENSAL ===== */
.accordion-item {
    border: none;
    margin-bottom: 1rem;
    border-radius: 12px !important;
    overflow: hidden;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
}

.accordion-button {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: none;
    padding: 1.5rem;
    font-weight: 600;
    color: #1e293b;
    border-radius: 12px !important;
    transition: all 0.3s ease;
}

.accordion-button:not(.collapsed) {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    box-shadow: none;
}

.accordion-button:focus {
    box-shadow: none;
    border: none;
}

.accordion-button::after {
    background-size: 1.2rem;
    width: 1.2rem;
    height: 1.2rem;
}

.accordion-body {
    padding: 1.5rem;
    background: white;
}

/* ===== BADGES E ALERTAS ===== */
.badge {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.4rem 0.8rem;
}

.alert {
    border-radius: 12px;
    border: none;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
}

.alert-info {
    background: rgba(52, 152, 219, 0.1);
    color: #2980b9;
    border-left: 4px solid #3498db;
}

.alert-success {
    background: rgba(46, 204, 113, 0.1);
    color: #27ae60;
    border-left: 4px solid #2ecc71;
}

.alert-warning {
    background: rgba(241, 196, 15, 0.1);
    color: #f39c12;
    border-left: 4px solid #f1c40f;
}

.alert-danger {
    background: rgba(231, 76, 60, 0.1);
    color: #c0392b;
    border-left: 4px solid #e74c3c;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 1200px) {
    .dashboard-header h1 {
        font-size: 1.8rem;
    }
    
    .metric-card h2 {
        font-size: 1.8rem;
    }
}

@media (max-width: 992px) {
    #appContent {
        border-radius: 20px;
    }
    
    .dashboard-header {
        padding: 1.5rem;
        text-align: center;
    }
    
    .dashboard-header h1 {
        justify-content: center;
        font-size: 1.6rem;
    }
    
    .filter-card .row > div {
        margin-bottom: 1rem;
    }
    
    .filter-card .row > div:last-child {
        margin-bottom: 0;
    }
    
    .losses-table {
        overflow-x: auto;
    }
    
    .losses-table table {
        min-width: 900px;
    }
}

@media (max-width: 768px) {
    body {
        padding: 10px;
        background: white;
    }
    
    #appContent {
        border-radius: 16px;
        box-shadow: none;
    }
    
    .dashboard-header {
        border-radius: 0 0 16px 16px;
    }
    
    .filter-card, .evolution-card, .losses-table {
        padding: 1.2rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .accordion-button {
        padding: 1rem;
        font-size: 0.95rem;
    }
    
    .accordion-body {
        padding: 1rem;
    }
}

@media (max-width: 576px) {
    .dashboard-header h1 {
        font-size: 1.4rem;
        flex-direction: column;
        gap: 10px;
    }
    
    .dashboard-header h1 i {
        margin-right: 0;
    }
    
    .metric-card {
        padding: 1.2rem;
    }
    
    .metric-card h2 {
        font-size: 1.6rem;
    }
    
    .evolution-card h5 {
        font-size: 1.1rem;
    }
    
    .losses-table h5 {
        font-size: 1.1rem;
    }
}

/* ===== ANIMAÇÕES ADICIONAIS ===== */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.metric-card, .evolution-card, .loss-item {
    animation: slideIn 0.5s ease-out;
}

/* ===== UTILITÁRIOS ===== */
.text-center {
    text-align: center;
}

.w-100 {
    width: 100%;
}

.mb-0 { margin-bottom: 0 !important; }
.mb-2 { margin-bottom: 0.5rem !important; }
.mb-3 { margin-bottom: 1rem !important; }
.mb-4 { margin-bottom: 1.5rem !important; }
.mt-2 { margin-top: 0.5rem !important; }
.mt-3 { margin-top: 1rem !important; }
.mt-4 { margin-top: 1.5rem !important; }
.me-1 { margin-right: 0.25rem !important; }
.me-2 { margin-right: 0.5rem !important; }
.ms-2 { margin-left: 0.5rem !important; }
.p-3 { padding: 1rem !important; }

/* ===== ESTADOS DE CARREGAMENTO ===== */
.loading {
    position: relative;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    border-radius: inherit;
    z-index: 10;
}



.loading::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 11;
    transform: translate(-50%, -50%);
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* ===== SCROLL PERSONALIZADO ===== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
    </style>
</head>
<body>
    <!-- Overlay de Login (inicialmente visível) -->
    <div id="loginOverlay" class="login-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Verificando autenticação...</span>
            </div>
            <p class="mt-3">Verificando autenticação...</p>
        </div>
    </div>

    <!-- Conteúdo principal (inicialmente escondido) -->
    <div id="appContent" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="p-3">
                <h4 class="text-white mb-4">
                    <i class="fas fa-chart-line me-2"></i>Análise de Desempenho
                </h4>
            </div>
            
            <div class="sidebar-menu">
                <a href="home.html">
                    <i class="fas fa-home me-2"></i>Home
                </a>
                <a href="ficha_performance.html">
                    <i class="fas fa-clipboard-check me-2"></i>Ficha de Performance
                </a>
                <a href="analise_pontos.html" class="active">
                    <i class="fas fa-search me-2"></i>Análise de Pontos
                </a>
            </div>
            
            <div class="p-3 mt-4">
                <div class="user-info mb-3 p-2 bg-dark rounded">
                    <small class="d-block">Usuário:</small>
                    <strong id="userName">-</strong>
                    <small class="d-block mt-1">Unidade:</small>
                    <span id="userUnit">-</span>
                </div>
                <button id="logoutBtn" class="btn btn-danger w-100">
                    <i class="fas fa-sign-out-alt me-2"></i>Sair
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="mb-3">
                    <i class="fas fa-chart-bar text-primary me-2"></i>
                    Análise de Pontos Perdidos
                </h1>
                <p class="text-white  mb-0">
                    Visualize onde os técnicos estão perdendo pontos e acompanhe a evolução ao longo do tempo
                </p>
            </div>

            <!-- Filters -->
            <div class="filter-card">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Técnico:</label>
                        <select id="tecnicoSelect" class="form-select">
                            <option value="">Todos os técnicos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unidade:</label>
                        <select id="unidadeSelect" class="form-select">
                            <option value="">Todas as unidades</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Período:</label>
                        <select id="periodoSelect" class="form-select">
                            <option value="3">Últimos 3 meses</option>
                            <option value="6" selected>Últimos 6 meses</option>
                            <option value="12">Últimos 12 meses</option>
                            <option value="all">Todo o período</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="btnFiltrar" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-2">Pontuação Média</h6>
                        <h2 id="avgScore">-</h2>
                        <div class="d-flex align-items-center">
                            <span id="scoreTrend" class="me-2">
                                <i class="fas fa-minus"></i>
                            </span>
                            <small id="scoreChange" class="text-muted">vs período anterior</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-2">Pontos Perdidos/Mês</h6>
                        <h2 id="avgLoss">-</h2>
                        <div class="progress progress-custom mt-2">
                            <div id="lossProgress" class="progress-bar bg-danger" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-2">Maior Perda</h6>
                        <h4 id="biggestLoss">-</h4>
                        <small id="lossCategory" class="text-muted">Categoria</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-2">Evolução</h6>
                        <h4 id="evolutionStatus">-</h4>
                        <small id="evolutionDetail" class="text-muted">Tendência</small>
                    </div>
                </div>
            </div>

            <!-- Charts and Tables -->
            <div class="row">
                <!-- Evolution Chart -->
                <div class="col-md-8">
                    <div class="evolution-card">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            Evolução Mensal
                        </h5>
                        <div class="chart-container">
                            <canvas id="evolutionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Category Distribution -->
                <div class="col-md-4">
                    <div class="evolution-card">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-pie me-2 text-primary"></i>
                            Distribuição das Perdas
                        </h5>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Losses -->
            <div class="row">
                <div class="col-12">
                    <div class="losses-table">
                        <div class="p-3 border-bottom">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                Principais Pontos Perdidos
                            </h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th>Categoria</th>
                                        <th>Pontos Perdidos</th>
                                        <th>Frequência</th>
                                        <th>Tendência</th>
                                        <th>Pontos Máximos</th>
                                        <th>% Perdido</th>
                                        <th>Recomendação</th>
                                    </tr>
                                </thead>
                                <tbody id="lossesTable">
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Improvement Areas -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="evolution-card">
                        <h5 class="mb-3">
                            <i class="fas fa-lightbulb me-2 text-success"></i>
                            Áreas para Melhoria
                        </h5>
                        <div id="improvementAreas" class="row">
                            <!-- Recomendações serão geradas dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Details -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="evolution-card">
                        <h5 class="mb-3">
                            <i class="fas fa-calendar-alt me-2 text-primary"></i>
                            Detalhamento Mensal
                        </h5>
                        <div id="monthlyDetails" class="accordion">
                            <!-- Acordeão será gerado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuração EXATA do Firebase (igual ao seu arquivo original)
        const firebaseConfig = {
        apiKey: "AIzaSyDZwa4XNqlupNDLs7-CRQbhr5pRT4NyFBA",
        authDomain: "application-gzl.firebaseapp.com",
        databaseURL: "https://application-gzl-default-rtdb.firebaseio.com",
        projectId: "application-gzl",
        storageBucket: "application-gzl.appspot.com",
        messagingSenderId: "319900903265",
        appId: "1:319900903265:web:a8f400aeb7a697fc168720",
        measurementId: "G-ZRRFQZXT54"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Variáveis globais
        let allRankings = [];
        let filteredData = [];
        let evolutionChartInstance = null;
        let categoryChartInstance = null;

        // Função para verificar autenticação
        function checkAuth() {
            console.log("Verificando autenticação...");
            
            // Verifica se há um usuário logado
            const user = auth.currentUser;
            
            if (user) {
                console.log("Usuário já está logado:", user.email);
                showAppContent();
                return;
            }
            
            // Se não estiver logado, tenta verificar se há sessão salva
            auth.onAuthStateChanged((user) => {
                console.log("Estado da autenticação mudou:", user ? "Logado" : "Não logado");
                
                if (user) {
                    console.log("Usuário autenticado via onAuthStateChanged:", user.email);
                    showAppContent();
                } else {
                    console.log("Nenhum usuário autenticado, redirecionando para login");
                    // Redireciona para a página de login
                    // Verifica se estamos na raiz ou em subpasta
                    const currentPath = window.location.pathname;
                    const isInSubfolder = currentPath.includes('/') && currentPath.split('/').length > 2;
                    
                    if (isInSubfolder) {
                        window.location.href = '../index.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }
            });
        }

        function showAppContent() {
            console.log("Mostrando conteúdo do app...");
            
            // Esconde o overlay de login
            document.getElementById('loginOverlay').style.display = 'none';
            
            // Mostra o conteúdo do app
            document.getElementById('appContent').style.display = 'flex';
            
            // Inicializa a aplicação
            initializeApp();
        }

        function initializeApp() {
            // Carrega dados do usuário atual
            const user = auth.currentUser;
            if (user) {
                loadUserData(user.uid);
                loadTecnicos();
                loadData();
                
                // Configura logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    auth.signOut().then(() => {
                        // Redireciona para login
                        const currentPath = window.location.pathname;
                        const isInSubfolder = currentPath.includes('/') && currentPath.split('/').length > 2;
                        
                        if (isInSubfolder) {
                            window.location.href = '../index.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                });
                
                // Configura filtros
                document.getElementById('btnFiltrar').addEventListener('click', applyFilters);
            }
        }

        async function loadUserData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('userName').textContent = userData.name || userData.email || '-';
                    document.getElementById('userUnit').textContent = userData.unit || '-';
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
            }
        }

        async function loadTecnicos() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const tecnicos = [];
                const unidades = new Set();

                usersSnapshot.forEach(doc => {
                    const user = doc.data();

                    tecnicos.push({
                        id: doc.id,
                        nome: user.name || user.email,
                        unidade: user.unit || 'N/I',
                        role: user.role || 'N/I'
                    });

                    if (user.unit) {
                        unidades.add(user.unit);
                    }
                });

                // Preencher select de técnicos
                const tecnicoSelect = document.getElementById('tecnicoSelect');
                tecnicoSelect.innerHTML = '<option value="">Todos os técnicos</option>';
                
                tecnicos.forEach(tecnico => {
                    const option = document.createElement('option');
                    option.value = tecnico.id;
                    option.textContent = `${tecnico.nome} - ${tecnico.unidade}`;
                    option.dataset.unidade = tecnico.unidade;
                    tecnicoSelect.appendChild(option);
                });

                // Preencher select de unidades
                const unidadeSelect = document.getElementById('unidadeSelect');
                unidadeSelect.innerHTML = '<option value="">Todas as unidades</option>';
                
                Array.from(unidades).sort().forEach(unidade => {
                    const option = document.createElement('option');
                    option.value = unidade;
                    option.textContent = unidade;
                    unidadeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao cargar técnicos:', error);
                showError('Erro ao carregar lista de técnicos');
            }
        }

        async function loadData() {
            try {
                console.log("Carregando dados do Firestore...");
                
                const snapshot = await db.collection('ranking-tst')
                    .orderBy('dataHora', 'desc')
                    .get();

                allRankings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // Garantir que dataHora seja um objeto Date
                    if (data.dataHora && typeof data.dataHora.toDate === 'function') {
                        data.dataHora = data.dataHora.toDate();
                    } else if (data.dataHora && data.dataHora.seconds) {
                        data.dataHora = new Date(data.dataHora.seconds * 1000);
                    } else if (typeof data.dataHora === 'string') {
                        data.dataHora = new Date(data.dataHora);
                    }
                    
                    // Calcular pontos perdidos por categoria
                    data.perdas = calcularPerdas(data);
                    data.totalPerdido = calcularTotalPerdido(data);
                    
                    allRankings.push(data);
                });

                console.log(`Carregados ${allRankings.length} registros`);
                applyFilters();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao carregar dados do ranking');
            }
        }

        function calcularPerdas(data) {
            const perdas = {
                operacional: {
                    auditoriaComportamental: Math.max(0, 8 - (data.auditoriaComportamental || 0)),
                    dto: Math.max(0, 5 - (data.dto || 0)),
                    cartaoVerde: Math.max(0, 5 - (data.cartaoVerde || 0)),
                    relatoDesvio: Math.max(0, 15 - (data.relatoDesvio || 0)),
                    ronda: Math.max(0, 12 - (data.ronda || 0))
                },
                documental: {
                    sistema: Math.max(0, 5 - (data.sistema || 0)),
                    gestaoPlanoAcao: Math.max(0, 5 - (data.gestaoPlanoAcao || 0)),
                    portal: Math.max(0, 5 - (data.Portal || 0)),
                    ofensores: Math.max(0, 10 - (data.Ofensores || 0))
                },
                ocorrencia: {
                    incidente: Math.min(35, data.incidente || 0),
                    osa: Math.min(35, data.osa || 0),
                    saf: Math.min(35, data.saf || 0),
                    caf: Math.min(35, data.caf || 0)
                },
                deflator: {
                    deflator: Math.min(10, data.deflator || 0),
                    participacao: Math.min(10, data.participacao || 0),
                    campanhas: Math.min(10, data.campanhas || 0)
                }
            };

            return perdas;
        }

        function calcularTotalPerdido(data) {
            const perdas = data.perdas;
            let total = 0;
            
            // Operacional
            total += perdas.operacional.auditoriaComportamental;
            total += perdas.operacional.dto;
            total += perdas.operacional.cartaoVerde;
            total += perdas.operacional.relatoDesvio;
            total += perdas.operacional.ronda;
            
            // Documental
            total += perdas.documental.sistema;
            total += perdas.documental.gestaoPlanoAcao;
            total += perdas.documental.portal;
            total += perdas.documental.ofensores;
            
            // Ocorrência
            total += perdas.ocorrencia.incidente;
            total += perdas.ocorrencia.osa;
            total += perdas.ocorrencia.saf;
            total += perdas.ocorrencia.caf;
            
            // Deflator
            total += perdas.deflator.deflator;
            total += perdas.deflator.participacao;
            total += perdas.deflator.campanhas;
            
            return total;
        }

        function applyFilters() {
            const tecnicoId = document.getElementById('tecnicoSelect').value;
            const unidade = document.getElementById('unidadeSelect').value;
            const periodo = document.getElementById('periodoSelect').value;
            
            filteredData = allRankings.filter(item => {
                // Filtro por técnico
                if (tecnicoId && item.tecnicoId !== tecnicoId) return false;
                
                // Filtro por unidade
                if (unidade && item.unidade !== unidade) return false;
                
                // Filtro por período
                if (periodo !== 'all' && item.dataHora) {
                    const itemDate = item.dataHora;
                    const monthsAgo = new Date();
                    monthsAgo.setMonth(monthsAgo.getMonth() - parseInt(periodo));
                    
                    if (itemDate < monthsAgo) return false;
                }
                
                return true;
            });

            console.log(`Filtrados ${filteredData.length} registros`);
            updateDashboard();
            updateCharts();
            updateLossesTable();
            updateImprovementAreas();
            updateMonthlyDetails();
        }

        function updateDashboard() {
            if (filteredData.length === 0) {
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('avgLoss').textContent = '-';
                document.getElementById('biggestLoss').textContent = '-';
                document.getElementById('evolutionStatus').textContent = '-';
                document.getElementById('lossProgress').style.width = '0%';
                return;
            }

            // Calcular média de pontos
            const avgScore = filteredData.reduce((sum, item) => sum + (item.totalGeral || 0), 0) / filteredData.length;
            document.getElementById('avgScore').textContent = avgScore.toFixed(1);

            // Calcular média de perdas
            const avgLoss = filteredData.reduce((sum, item) => sum + (item.totalPerdido || 0), 0) / filteredData.length;
            document.getElementById('avgLoss').textContent = avgLoss.toFixed(1);

            // Calcular progresso de perdas (0-100%)
            const maxPossibleLoss = 45 + 20 + 35 + 30;
            const lossPercentage = Math.min((avgLoss / maxPossibleLoss) * 100, 100);
            document.getElementById('lossProgress').style.width = `${lossPercentage}%`;

            // Encontrar maior perda
            let biggestLoss = { value: 0, category: '', item: '' };
            const perdasAgrupadas = {};

            filteredData.forEach(item => {
                if (!item.perdas) return;
                
                Object.keys(item.perdas).forEach(categoria => {
                    Object.keys(item.perdas[categoria]).forEach(subItem => {
                        const key = `${categoria}.${subItem}`;
                        if (!perdasAgrupadas[key]) perdasAgrupadas[key] = 0;
                        perdasAgrupadas[key] += item.perdas[categoria][subItem] || 0;
                    });
                });
            });

            Object.keys(perdasAgrupadas).forEach(key => {
                if (perdasAgrupadas[key] > biggestLoss.value) {
                    biggestLoss = {
                        value: perdasAgrupadas[key],
                        category: key.split('.')[0],
                        item: key.split('.')[1]
                    };
                }
            });

            document.getElementById('biggestLoss').textContent = biggestLoss.value > 0 ? biggestLoss.value.toFixed(1) : '-';
            document.getElementById('lossCategory').textContent = biggestLoss.value > 0 ? 
                `${traduzirCategoria(biggestLoss.category)} - ${traduzirItem(biggestLoss.item)}` : 'Nenhuma perda significativa';

            // Calcular tendência
            if (filteredData.length >= 2) {
                const primeiroMes = filteredData[filteredData.length - 1];
                const ultimoMes = filteredData[0];
                const evolucao = (ultimoMes.totalGeral || 0) - (primeiroMes.totalGeral || 0);
                
                const trendIcon = document.getElementById('scoreTrend');
                const evolutionStatus = document.getElementById('evolutionStatus');
                
                if (evolucao > 5) {
                    trendIcon.innerHTML = '<i class="fas fa-arrow-up trend-up"></i>';
                    trendIcon.className = 'trend-up me-2';
                    evolutionStatus.textContent = 'Melhorando';
                    evolutionStatus.className = 'trend-up';
                    document.getElementById('evolutionDetail').textContent = `+${evolucao.toFixed(1)} pontos`;
                } else if (evolucao < -5) {
                    trendIcon.innerHTML = '<i class="fas fa-arrow-down trend-down"></i>';
                    trendIcon.className = 'trend-down me-2';
                    evolutionStatus.textContent = 'Piorando';
                    evolutionStatus.className = 'trend-down';
                    document.getElementById('evolutionDetail').textContent = `${evolucao.toFixed(1)} pontos`;
                } else {
                    trendIcon.innerHTML = '<i class="fas fa-minus trend-stable"></i>';
                    trendIcon.className = 'trend-stable me-2';
                    evolutionStatus.textContent = 'Estável';
                    evolutionStatus.className = 'trend-stable';
                    document.getElementById('evolutionDetail').textContent = 'Variação mínima';
                }
            }
        }

        function updateCharts() {
            // Agrupar dados por mês
            const dadosPorMes = {};
            
            filteredData.forEach(item => {
                if (!item.dataHora) return;
                
                const date = item.dataHora;
                const mes = date.getMonth() + 1;
                const ano = date.getFullYear();
                const mesAno = `${mes.toString().padStart(2, '0')}/${ano}`;
                
                if (!dadosPorMes[mesAno]) {
                    dadosPorMes[mesAno] = {
                        total: 0,
                        operacional: 0,
                        documental: 0,
                        ocorrencia: 0,
                        deflator: 0,
                        count: 0
                    };
                }
                
                dadosPorMes[mesAno].total += item.totalGeral || 0;
                dadosPorMes[mesAno].operacional += item.totalOperacional || 0;
                dadosPorMes[mesAno].documental += item.totalDocumental || 0;
                dadosPorMes[mesAno].ocorrencia += item.totalOcorrencia || 0;
                dadosPorMes[mesAno].deflator += item.totalDeflator || 0;
                dadosPorMes[mesAno].count++;
            });

            // Ordenar meses
            const mesesOrdenados = Object.keys(dadosPorMes).sort((a, b) => {
                const [mesA, anoA] = a.split('/').map(Number);
                const [mesB, anoB] = b.split('/').map(Number);
                return new Date(anoA, mesA - 1) - new Date(anoB, mesB - 1);
            });

            if (mesesOrdenados.length === 0) {
                // Criar gráfico vazio
                createEmptyCharts();
                return;
            }

            // Preparar dados para gráfico de evolução
            const medias = mesesOrdenados.map(mes => 
                dadosPorMes[mes].total / dadosPorMes[mes].count
            );

            // Gráfico de evolução
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            
            if (evolutionChartInstance) {
                evolutionChartInstance.destroy();
            }

            evolutionChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: mesesOrdenados,
                    datasets: [{
                        label: 'Pontuação Média',
                        data: medias,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Pontuação'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mês/Ano'
                            }
                        }
                    }
                }
            });

            // Gráfico de distribuição
            const perdasPorCategoria = {
                operacional: 0,
                documental: 0,
                ocorrencia: 0,
                deflator: 0
            };

            filteredData.forEach(item => {
                if (!item.perdas) return;
                
                Object.keys(item.perdas).forEach(categoria => {
                    Object.keys(item.perdas[categoria]).forEach(subItem => {
                        perdasPorCategoria[categoria] += item.perdas[categoria][subItem] || 0;
                    });
                });
            });

            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            categoryChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Operacional', 'Documental', 'Ocorrência', 'Deflator'],
                    datasets: [{
                        data: [
                            perdasPorCategoria.operacional,
                            perdasPorCategoria.documental,
                            perdasPorCategoria.ocorrencia,
                            perdasPorCategoria.deflator
                        ],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(241, 196, 15, 0.8)',
                            'rgba(46, 204, 113, 0.8)'
                        ],
                        borderColor: [
                            '#3498db',
                            '#9b59b6',
                            '#f1c40f',
                            '#2ecc71'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createEmptyCharts() {
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            
            if (evolutionChartInstance) evolutionChartInstance.destroy();
            if (categoryChartInstance) categoryChartInstance.destroy();

            evolutionChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sem dados',
                        data: [],
                        borderColor: '#ccc',
                        backgroundColor: 'rgba(204, 204, 204, 0.1)'
                    }]
                }
            });

            categoryChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Sem dados'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#ccc']
                    }]
                }
            });
        }

        function updateLossesTable() {
            const tableBody = document.getElementById('lossesTable');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhum dado encontrado para os filtros selecionados
                        </td>
                    </tr>
                `;
                return;
            }

            // Agrupar perdas por item
            const perdasPorItem = {};
            
            filteredData.forEach(item => {
                if (!item.perdas) return;
                
                Object.keys(item.perdas).forEach(categoria => {
                    Object.keys(item.perdas[categoria]).forEach(subItem => {
                        const key = `${categoria}.${subItem}`;
                        if (!perdasPorItem[key]) {
                            perdasPorItem[key] = {
                                total: 0,
                                count: 0,
                                categoria: categoria,
                                maxPoints: getMaxPoints(categoria, subItem)
                            };
                        }
                        perdasPorItem[key].total += item.perdas[categoria][subItem] || 0;
                        perdasPorItem[key].count++;
                    });
                });
            });

            // Converter para array e ordenar
            const itensArray = Object.keys(perdasPorItem).map(key => ({
                nome: key,
                ...perdasPorItem[key]
            })).filter(item => item.total > 0) // Filtrar apenas itens com perdas
              .sort((a, b) => {
                const avgA = a.total / a.count;
                const avgB = b.total / b.count;
                return avgB - avgA;
              });

            if (itensArray.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Nenhuma perda significativa encontrada nos dados filtrados
                        </td>
                    </tr>
                `;
                return;
            }

            // Limitar a 10 principais
            const principaisItens = itensArray.slice(0, 10);

            // Preencher tabela
            tableBody.innerHTML = '';
            principaisItens.forEach(item => {
                const avgLoss = item.total / item.count;
                const percentage = item.maxPoints > 0 ? (avgLoss / item.maxPoints) * 100 : 0;
                const trend = calcularTendenciaItem(item.nome);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${traduzirItem(item.nome.split('.')[1])}</strong>
                    </td>
                    <td>
                        <span class="category-badge badge-${item.categoria}">
                            ${traduzirCategoria(item.categoria)}
                        </span>
                    </td>
                    <td>
                        <strong>${avgLoss.toFixed(1)}</strong>
                        <small class="text-muted d-block">por avaliação</small>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress progress-custom flex-grow-1 me-2">
                                <div class="progress-bar bg-warning" style="width: ${(item.count / filteredData.length) * 100}%"></div>
                            </div>
                            <span>${item.count}</span>
                        </div>
                    </td>
                    <td>
                        ${renderizarTendencia(trend)}
                    </td>
                    <td>${item.maxPoints}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress progress-custom flex-grow-1 me-2">
                                <div class="progress-bar ${percentage > 50 ? 'bg-danger' : percentage > 25 ? 'bg-warning' : 'bg-info'}" 
                                     style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <span>${percentage.toFixed(0)}%</span>
                        </div>
                    </td>
                    <td>
                        <small>${gerarRecomendacao(item.nome, percentage)}</small>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function calcularTendenciaItem(itemKey) {
            // Implementação simplificada
            return Math.random() > 0.6 ? 'up' : Math.random() > 0.6 ? 'down' : 'stable';
        }

        function renderizarTendencia(trend) {
            const icons = {
                up: '<i class="fas fa-arrow-up trend-up"></i> Melhorando',
                down: '<i class="fas fa-arrow-down trend-down"></i> Piorando',
                stable: '<i class="fas fa-minus trend-stable"></i> Estável'
            };
            return icons[trend] || icons.stable;
        }

        function getMaxPoints(categoria, item) {
            const maxPoints = {
                operacional: {
                    auditoriaComportamental: 8,
                    dto: 5,
                    cartaoVerde: 5,
                    relatoDesvio: 15,
                    ronda: 12
                },
                documental: {
                    sistema: 5,
                    gestaoPlanoAcao: 5,
                    portal: 5,
                    ofensores: 10
                },
                ocorrencia: {
                    incidente: 35,
                    osa: 35,
                    saf: 35,
                    caf: 35
                },
                deflator: {
                    deflator: 10,
                    participacao: 10,
                    campanhas: 10
                }
            };
            return maxPoints[categoria]?.[item] || 0;
        }

        function traduzirCategoria(categoria) {
            const traducoes = {
                operacional: 'Operacional',
                documental: 'Documental',
                ocorrencia: 'Ocorrência',
                deflator: 'Deflator'
            };
            return traducoes[categoria] || categoria;
        }

        function traduzirItem(item) {
            const traducoes = {
                auditoriaComportamental: 'Auditoria Comportamental',
                dto: 'DTO',
                cartaoVerde: 'Cartão Verde',
                relatoDesvio: 'Relato de Desvio',
                ronda: 'Ronda',
                sistema: 'Rede + Sistemas',
                gestaoPlanoAcao: 'Gestão do Plano de Ação',
                portal: 'Portal',
                ofensores: 'Gestão dos Ofensores',
                incidente: 'Incidente',
                osa: 'OSA',
                saf: 'SAF',
                caf: 'CAF',
                deflator: 'Qualidade da Aplicação',
                participacao: 'Participação em Reuniões',
                campanhas: 'Aplicação de Campanhas'
            };
            return traducoes[item] || item;
        }

        function gerarRecomendacao(itemKey, percentage) {
            const item = itemKey.split('.')[1];
            
            const recomendacoes = {
                auditoriaComportamental: 'Aumentar frequência das auditorias e feedbacks imediatos',
                dto: 'Implementar checklist diário para verificação de DTO',
                cartaoVerde: 'Capacitar equipe sobre os critérios do cartão verde',
                relatoDesvio: 'Incentivar a cultura de reportar desvios sem punição',
                ronda: 'Estabelecer roteiro fixo e horários definidos para rondas',
                sistema: 'Verificar se todos os sistemas estão acessíveis e funcionando',
                gestaoPlanoAcao: 'Revisar prazos e responsáveis dos planos de ação',
                portal: 'Treinar equipe no uso do portal corporativo',
                ofensores: 'Priorizar ações corretivas para os principais ofensores',
                incidente: 'Analisar causas raiz dos incidentes recorrentes',
                osa: 'Melhorar procedimentos de operação segura',
                saf: 'Reforçar treinamento em segurança e meio ambiente',
                caf: 'Implementar auditorias preventivas',
                deflator: 'Padronizar a aplicação dos procedimentos',
                participacao: 'Registrar presença e participação ativa nas reuniões',
                campanhas: 'Divulgar e aplicar campanhas corporativas'
            };

            let recom = recomendacoes[item] || 'Revisar procedimentos específicos desta área';
            
            if (percentage > 75) {
                recom = '🔴 ' + recom + ' (URGENTE - alta perda de pontos)';
            } else if (percentage > 50) {
                recom = '🟡 ' + recom + ' (ATENÇÃO - perda significativa)';
            } else if (percentage > 25) {
                recom = '🟠 ' + recom + ' (MONITORAR - perda moderada)';
            } else {
                recom = '🟢 ' + recom + ' (CONTROLE - perda aceitável)';
            }
            
            return recom;
        }

        function updateImprovementAreas() {
            const container = document.getElementById('improvementAreas');
            
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhum dado disponível para gerar recomendações
                        </div>
                    </div>
                `;
                return;
            }

            // Identificar principais áreas para melhoria
            const perdasPorItem = {};
            
            filteredData.forEach(item => {
                if (!item.perdas) return;
                
                Object.keys(item.perdas).forEach(categoria => {
                    Object.keys(item.perdas[categoria]).forEach(subItem => {
                        const key = `${categoria}.${subItem}`;
                        if (!perdasPorItem[key]) {
                            perdasPorItem[key] = {
                                total: 0,
                                count: 0,
                                categoria: categoria,
                                item: subItem
                            };
                        }
                        perdasPorItem[key].total += item.perdas[categoria][subItem] || 0;
                        perdasPorItem[key].count++;
                    });
                });
            });

            // Converter para array e ordenar
            const itensArray = Object.keys(perdasPorItem).map(key => ({
                nome: key,
                ...perdasPorItem[key]
            })).filter(item => item.total > 0)
              .sort((a, b) => {
                const avgA = a.total / a.count;
                const avgB = b.total / b.count;
                return avgB - avgA;
              });

            // Pegar top 3 ou menos
            const topItens = itensArray.slice(0, 3);
            
            if (topItens.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Excelente! Nenhuma área crítica identificada para melhoria
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            topItens.forEach((item, index) => {
                const avgLoss = item.total / item.count;
                const maxPoints = getMaxPoints(item.categoria, item.item);
                const percentage = maxPoints > 0 ? (avgLoss / maxPoints) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = `col-md-${12 / topItens.length} mb-3`;
                card.innerHTML = `
                    <div class="loss-item ${percentage > 50 ? 'loss-high' : percentage > 25 ? 'loss-medium' : 'loss-low'}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${traduzirItem(item.item)}</h6>
                            <span class="category-badge badge-${item.categoria}">
                                ${traduzirCategoria(item.categoria)}
                            </span>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <small>Perda média:</small>
                                <strong>${avgLoss.toFixed(1)} pontos</strong>
                            </div>
                            <div class="progress progress-custom mt-1">
                                <div class="progress-bar ${percentage > 50 ? 'bg-danger' : percentage > 25 ? 'bg-warning' : 'bg-info'}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            ${gerarRecomendacao(item.nome, percentage).replace(/[🔴🟡🟠🟢].*?\)/, '').trim()}
                        </small>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateMonthlyDetails() {
            const container = document.getElementById('monthlyDetails');
            
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        Nenhum dado disponível para detalhamento mensal
                    </div>
                `;
                return;
            }

            // Agrupar por mês
            const dadosPorMes = {};
            
            filteredData.forEach(item => {
                if (!item.dataHora) return;
                
                const date = item.dataHora;
                const mes = date.getMonth() + 1;
                const ano = date.getFullYear();
                const mesAno = `${mes.toString().padStart(2, '0')}/${ano}`;
                
                if (!dadosPorMes[mesAno]) {
                    dadosPorMes[mesAno] = [];
                }
                dadosPorMes[mesAno].push(item);
            });

            // Ordenar meses
            const mesesOrdenados = Object.keys(dadosPorMes).sort((a, b) => {
                const [mesA, anoA] = a.split('/').map(Number);
                const [mesB, anoB] = b.split('/').map(Number);
                return new Date(anoB, mesB - 1) - new Date(anoA, mesA - 1);
            });

            // Criar acordeão
            let accordionHTML = '';
            mesesOrdenados.forEach((mesAno, index) => {
                const registros = dadosPorMes[mesAno];
                const primeiroRegistro = registros[0];
                const tecnicoNome = primeiroRegistro?.tecnicoNome || 'Não informado';
                const unidade = primeiroRegistro?.unidade || 'Não informada';
                
                // Calcular médias
                const totalPontos = registros.reduce((sum, r) => sum + (r.totalGeral || 0), 0) / registros.length;
                const totalPerdido = registros.reduce((sum, r) => sum + (r.totalPerdido || 0), 0) / registros.length;
                
                // Calcular principais perdas do mês
                const perdasDoMes = {};
                registros.forEach(reg => {
                    if (!reg.perdas) return;
                    
                    Object.keys(reg.perdas).forEach(categoria => {
                        Object.keys(reg.perdas[categoria]).forEach(item => {
                            const key = `${categoria}.${item}`;
                            if (!perdasDoMes[key]) perdasDoMes[key] = 0;
                            perdasDoMes[key] += reg.perdas[categoria][item] || 0;
                        });
                    });
                });

                // Ordenar perdas
                const principaisPerdas = Object.keys(perdasDoMes)
                    .map(key => ({ 
                        item: key, 
                        pontos: perdasDoMes[key],
                        categoria: key.split('.')[0]
                    }))
                    .filter(p => p.pontos > 0)
                    .sort((a, b) => b.pontos - a.pontos)
                    .slice(0, 5);

                accordionHTML += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading${index}">
                            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse${index}"
                                    aria-expanded="${index === 0 ? 'true' : 'false'}"
                                    aria-controls="collapse${index}">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <strong>${mesAno}</strong>
                                        <small class="ms-2 text-muted">${tecnicoNome} - ${unidade}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary me-2">${totalPontos.toFixed(1)} pts</span>
                                        <span class="badge bg-danger">Perda: ${totalPerdido.toFixed(1)} pts</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse${index}" 
                             class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
                             aria-labelledby="heading${index}">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Principais Perdas:</h6>
                                        ${principaisPerdas.length > 0 ? `
                                            <ul class="list-group">
                                                ${principaisPerdas.map(perda => {
                                                    const [categoria, item] = perda.item.split('.');
                                                    const media = perda.pontos / registros.length;
                                                    return `
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <small class="text-muted">${traduzirCategoria(categoria)}</small><br>
                                                                ${traduzirItem(item)}
                                                            </div>
                                                            <span class="badge bg-danger rounded-pill">${media.toFixed(1)}</span>
                                                        </li>
                                                    `;
                                                }).join('')}
                                            </ul>
                                        ` : '<p class="text-muted">Nenhuma perda significativa neste mês</p>'}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Resumo do Mês:</h6>
                                        <div class="row">
                                            <div class="col-6 mb-2">
                                                <small class="text-muted">Pontuação Operacional:</small>
                                                <div class="fw-bold">
                                                    ${(registros.reduce((sum, r) => sum + (r.totalOperacional || 0), 0) / registros.length).toFixed(1)} pts
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <small class="text-muted">Pontuação Documental:</small>
                                                <div class="fw-bold">
                                                    ${(registros.reduce((sum, r) => sum + (r.totalDocumental || 0), 0) / registros.length).toFixed(1)} pts
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <small class="text-muted">Pontuação Ocorrência:</small>
                                                <div class="fw-bold">
                                                    ${(registros.reduce((sum, r) => sum + (r.totalOcorrencia || 0), 0) / registros.length).toFixed(1)} pts
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <small class="text-muted">Deflator:</small>
                                                <div class="fw-bold">
                                                    ${(registros.reduce((sum, r) => sum + (r.totalDeflator || 0), 0) / registros.length).toFixed(1)} pts
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6>Recomendação do Mês:</h6>
                                            <div class="alert ${totalPontos < 75 ? 'alert-warning' : 'alert-info'}">
                                                <small>
                                                    <i class="fas fa-bullseye me-1"></i>
                                                    ${gerarRecomendacaoMensal(totalPontos, principaisPerdas[0]?.item)}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = accordionHTML;
            
            // Ativar os accordions do Bootstrap
            const accordions = container.querySelectorAll('.accordion-collapse');
            accordions.forEach(accordion => {
                new bootstrap.Collapse(accordion, {
                    toggle: false
                });
            });
        }

        function gerarRecomendacaoMensal(pontuacao, maiorPerda) {
            if (pontuacao < 60) {
                return 'NÍVEL CRÍTICO - Revisão urgente dos processos operacionais e treinamento imediato da equipe.';
            } else if (pontuacao < 75) {
                return 'NECESSIDADE DE MELHORIA - Focar na padronização dos procedimentos e eliminar as principais falhas identificadas.';
            } else if (pontuacao < 90) {
                return 'DESEMPENHO SATISFATÓRIO - Manter os bons resultados e trabalhar nos pontos de atenção.';
            } else {
                return 'EXCELENTE DESEMPENHO - Manter o padrão de qualidade e compartilhar as melhores práticas com a equipe.';
            }
        }

        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Inicia a verificação de autenticação quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM carregado, verificando autenticação...");
            checkAuth();
        });
    </script>
</body>
</html>