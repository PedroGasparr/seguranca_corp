<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Perfomance</title>
    
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        /* Reset e variáveis */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --azul-principal: #1a5f7a;
            --azul-secundario: #2c8fb5;
            --verde-sucesso: #28a745;
            --laranja-alerta: #fd7e14;
            --vermelho-perigo: #dc3545;
            --amarelo-destaque: #ffc107;
            --cinza-claro: #f8f9fa;
            --cinza-medio: #e9ecef;
            --cinza-escuro: #6c757d;
            --branco: #ffffff;
            --preto: #212529;
            --sombra-suave: 0 2px 10px rgba(0, 0, 0, 0.08);
            --sombra-media: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transicao: all 0.3s ease;
        }

        /* Estilos gerais */
        body {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        /* Container principal */
        .container-fluid {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header - Cabeçalho */
        .header {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-secundario));
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: var(--sombra-media);
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        .header-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        /* Estatísticas do header */
        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 25px;
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            color: white;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard-card {
            background: var(--branco);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--sombra-suave);
            transition: var(--transicao);
            border: 1px solid var(--cinza-medio);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--sombra-media);
            border-color: var(--azul-secundario);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--azul-secundario);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--azul-secundario), var(--azul-principal));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.95rem;
            color: var(--cinza-escuro);
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--azul-principal);
            margin-bottom: 10px;
            line-height: 1;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: var(--cinza-escuro);
            margin: 0;
        }

        /* Filtros */
        .filters-section {
            background: var(--branco);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--sombra-suave);
            border: 1px solid var(--cinza-medio);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--azul-principal);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--cinza-medio);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--azul-secundario);
        }

        /* Grupos de filtro */
        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--azul-principal);
            margin-bottom: 8px;
            display: block;
            font-size: 0.95rem;
        }

        .search-box {
            position: relative;
        }

        .search-box .input-group-text {
            background: var(--cinza-claro);
            border: 1px solid var(--cinza-medio);
            border-right: none;
        }

        .search-box input {
            border-left: none;
            padding-left: 0;
        }

        .search-box input:focus {
            border-color: var(--azul-secundario);
            box-shadow: 0 0 0 0.2rem rgba(44, 143, 181, 0.25);
        }

        /* Botões de mês */
        .month-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .month-btn {
            padding: 8px 15px;
            border: 2px solid var(--cinza-medio);
            background: var(--branco);
            color: var(--cinza-escuro);
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transicao);
            cursor: pointer;
        }

        .month-btn:hover {
            background: var(--cinza-claro);
            border-color: var(--azul-secundario);
        }

        .month-btn.active {
            background: var(--azul-secundario);
            color: white;
            border-color: var(--azul-secundario);
        }

        /* Contêiner da tabela */
        .table-container {
            background: var(--branco);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--sombra-suave);
            border: 1px solid var(--cinza-medio);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--azul-principal);
            margin: 0;
        }

        /* Tabela de ranking */
        .ranking-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            min-width: 1200px;
        }

        .ranking-table thead {
            background: linear-gradient(to right, var(--azul-principal), var(--azul-secundario));
        }

        .ranking-table th {
            padding: 18px 15px;
            text-align: center;
            font-weight: 700;
            color: white;
            border: none;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .ranking-table tbody tr {
            background: var(--branco);
            transition: var(--transicao);
        }

        .ranking-table tbody tr:nth-child(even) {
            background: var(--cinza-claro);
        }

        .ranking-table tbody tr:hover {
            background: #e3f2fd;
            transform: scale(1.005);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .ranking-table td {
            padding: 16px 15px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid var(--cinza-medio);
            font-size: 0.95rem;
        }

        /* Coluna de posição */
        .posicao-cell {
            font-weight: 700;
            width: 80px;
        }

        .posicao-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin: 0 auto;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .posicao-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
        }

        .posicao-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: #333;
            box-shadow: 0 4px 10px rgba(192, 192, 192, 0.3);
        }

        .posicao-3 {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: white;
            box-shadow: 0 4px 10px rgba(205, 127, 50, 0.3);
        }

        .posicao-outros {
            background: var(--cinza-claro);
            color: var(--azul-principal);
            border: 2px solid var(--cinza-medio);
        }

        /* Informações do técnico */
        .tecnico-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 250px;
        }

        .tecnico-foto-container {
            position: relative;
            flex-shrink: 0;
        }

        .tecnico-foto {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--azul-secundario);
            background: var(--cinza-claro);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .foto-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--azul-secundario), var(--azul-principal));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            border: 3px solid var(--azul-secundario);
        }

        .tecnico-detalhes {
            text-align: left;
            flex: 1;
        }

        .tecnico-nome {
            font-weight: 700;
            color: var(--azul-principal);
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .tecnico-unidade {
            font-size: 0.9rem;
            color: var(--cinza-escuro);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tecnico-unidade i {
            color: var(--azul-secundario);
        }

        /* Pontuação total */
        .pontos-total {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--verde-sucesso);
            padding: 10px 20px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 10px;
            display: inline-block;
            min-width: 100px;
            border: 2px solid rgba(40, 167, 69, 0.2);
        }

        /* Células dos meses */
        .mes-cell {
            min-width: 80px;
        }

        .mes-valor {
            font-weight: 600;
            color: var(--azul-principal);
            background: rgba(44, 143, 181, 0.1);
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            min-width: 60px;
            transition: var(--transicao);
            border: 2px solid transparent;
        }

        .mes-valor:hover {
            background: rgba(44, 143, 181, 0.2);
            border-color: var(--azul-secundario);
        }

        .mes-sem-pontos {
            color: var(--cinza-escuro);
            font-style: italic;
            padding: 10px;
            opacity: 0.7;
        }

        .mes-destaque {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid var(--amarelo-destaque);
        }

        /* Barra de progresso */
        .progresso-container {
            width: 100%;
            height: 6px;
            background: var(--cinza-medio);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progresso-bar {
            height: 100%;
            background: linear-gradient(to right, var(--azul-secundario), var(--verde-sucesso));
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        /* Botões de ação */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-group-left, .btn-group-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: var(--transicao);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--azul-secundario);
            color: white;
        }

        .btn-primary:hover {
            background: var(--azul-principal);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 143, 181, 0.3);
        }

        .btn-success {
            background: var(--verde-sucesso);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-outline {
            background: transparent;
            border-color: var(--cinza-medio);
            color: var(--azul-principal);
        }

        .btn-outline:hover {
            background: var(--cinza-claro);
            border-color: var(--azul-secundario);
        }

        /* Informação dos filtros */
        .filter-info {
            background: rgba(44, 143, 181, 0.1);
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--azul-secundario);
        }

        .filter-text {
            font-size: 0.95rem;
            color: var(--azul-principal);
            margin: 0;
            font-weight: 600;
        }

        /* Estados de carregamento e vazio */
        .loading-state, .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--cinza-medio);
            border-top-color: var(--azul-secundario);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--cinza-medio);
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 1.5rem;
            color: var(--azul-principal);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .empty-text {
            color: var(--cinza-escuro);
            margin-bottom: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--cinza-claro);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--azul-secundario);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--azul-principal);
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .table-container {
                overflow-x: auto;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .tecnico-info {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .tecnico-detalhes {
                text-align: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-group-left, .btn-group-right {
                width: 100%;
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            .month-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .header-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ranking-table {
                font-size: 0.9rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 12px 8px;
            }
            
            .tecnico-foto,
            .foto-placeholder {
                width: 50px;
                height: 50px;
            }
        }

        /* Estilos para impressão */
        @media print {
            .action-buttons,
            .filters-section,
            .dashboard-cards {
                display: none !important;
            }
            
            body {
                background: white;
                padding: 0;
            }
            
            .table-container {
                box-shadow: none;
                border: none;
                padding: 0;
            }
            
            .ranking-table tbody tr:hover {
                background: transparent !important;
                transform: none !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h1>Mapa de Perfomance</h1>
                <p class="header-subtitle">Classificação anual baseada nas pontuações mensais</p>
                
                <div class="header-stats" id="headerStats">
                    <!-- Estatísticas serão preenchidas via JavaScript -->
                    <div class="stat-item">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Técnicos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">0.0</div>
                        <div class="stat-label">Média de Pontos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">0.0</div>
                        <div class="stat-label">Pontuação Máxima</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Unidades</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="dashboard-cards">
            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="card-title">Total de Técnicos</div>
                <div class="card-value" id="totalTecnicos">0</div>
                <div class="card-subtitle">Competindo este ano</div>
            </div>
            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-title">Média de Pontos</div>
                <div class="card-value" id="mediaPontos">0.0</div>
                <div class="card-subtitle">Por técnico</div>
            </div>
            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-medal"></i>
                </div>
                <div class="card-title">Líder Atual</div>
                <div class="card-value" id="liderAtual">-</div>
                <div class="card-subtitle" id="pontosLider">0.0 pontos</div>
            </div>
            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="card-title">Meses Ativos</div>
                <div class="card-value" id="mesesAtivos">0/12</div>
                <div class="card-subtitle">Período de competição</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <h3 class="section-title"><i class="fas fa-filter"></i> Filtros e Configurações</h3>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="filter-group">
                        <label class="filter-label">Buscar Técnico</label>
                        <div class="search-box">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Digite o nome do técnico...">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Unidade</label>
                        <select class="form-select" id="filterUnidade">
                            <option value="">Todas as unidades</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Ano</label>
                        <select class="form-select" id="filterAno">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="filter-group">
                        <label class="filter-label">Ordenar por</label>
                        <select class="form-select" id="sortBy">
                            <option value="total">Pontos Totais</option>
                            <option value="nome">Nome</option>
                            <option value="unidade">Unidade</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="filter-group">
                        <label class="filter-label">Filtrar por Mês</label>
                        <div class="month-buttons">
                            <button class="month-btn active" data-mes="0">Todos</button>
                            <button class="month-btn" data-mes="1">Jan</button>
                            <button class="month-btn" data-mes="2">Fev</button>
                            <button class="month-btn" data-mes="3">Mar</button>
                            <button class="month-btn" data-mes="4">Abr</button>
                            <button class="month-btn" data-mes="5">Mai</button>
                            <button class="month-btn" data-mes="6">Jun</button>
                            <button class="month-btn" data-mes="7">Jul</button>
                            <button class="month-btn" data-mes="8">Ago</button>
                            <button class="month-btn" data-mes="9">Set</button>
                            <button class="month-btn" data-mes="10">Out</button>
                            <button class="month-btn" data-mes="11">Nov</button>
                            <button class="month-btn" data-mes="12">Dez</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline" id="resetFilters">
                                <i class="fas fa-redo"></i> Limpar Filtros
                            </button>
                            <button class="btn btn-outline" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                        <div class="filter-info">
                            <p class="filter-text" id="filterInfo">
                                Mostrando <span id="filterCount">0</span> de <span id="totalCount">0</span> técnicos
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Ranking -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Classificação Geral do Ranking</h3>
                <div class="table-actions">
                    <button class="btn btn-outline" id="printBtn">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Técnico</th>
                            <th>Pontos Totais</th>
                            <th>
                                <div class="mes-header" data-mes="1">
                                    JAN
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="2">
                                    FEV
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="3">
                                    MAR
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="4">
                                    ABR
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="5">
                                    MAI
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="6">
                                    JUN
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="7">
                                    JUL
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="8">
                                    AGO
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="9">
                                    SET
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="10">
                                    OUT
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="11">
                                    NOV
                                </div>
                            </th>
                            <th>
                                <div class="mes-header" data-mes="12">
                                    DEZ
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                        <tr>
                            <td colspan="15">
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <p class="mt-3">Carregando dados do ranking...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="action-buttons">
            <div class="btn-group-left">
                <button class="btn btn-primary" onclick="window.location.href='home.html'">
                    <i class="fas fa-home"></i> Voltar para Home
                </button>
            </div>
            <div class="btn-group-right">
                <button class="btn btn-success" id="exportBtn">
                    <i class="fas fa-download"></i> Exportar Excel
                </button>
                <button class="btn btn-primary" id="exportPDFBtn">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Auth Script -->
    <script src="../js/auth.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Inicializa Google Charts
        google.charts.load('current', {'packages':['corechart']});

        class RankingApp {
            constructor() {
                this.dadosRanking = [];
                this.dadosFiltrados = [];
                this.tecnicoFotos = {};
                this.unidadesDisponiveis = new Set();
                this.mesesNomes = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                this.currentFilters = {
                    search: '',
                    unidade: '',
                    ano: '2026',
                    mes: 0,
                    sortBy: 'total'
                };
                
                this.initialize();
            }

            async initialize() {
                this.bindEvents();
                this.checkAuth();
            }

            bindEvents() {
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.currentFilters.search = e.target.value.toLowerCase();
                    this.filterData();
                });

                // Unit filter
                document.getElementById('filterUnidade').addEventListener('change', (e) => {
                    this.currentFilters.unidade = e.target.value;
                    this.filterData();
                });

                // Year filter
                document.getElementById('filterAno').addEventListener('change', (e) => {
                    this.currentFilters.ano = e.target.value;
                    this.loadRankingData();
                });

                // Sort by
                document.getElementById('sortBy').addEventListener('change', (e) => {
                    this.currentFilters.sortBy = e.target.value;
                    this.sortData();
                    this.renderTable();
                });

                // Month buttons
                document.querySelectorAll('.month-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const mes = parseInt(e.target.dataset.mes);
                        this.currentFilters.mes = mes;
                        
                        // Update button states
                        document.querySelectorAll('.month-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        
                        this.filterData();
                    });
                });

                // Month headers in table
                document.querySelectorAll('.mes-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const mes = parseInt(e.target.dataset.mes);
                        this.currentFilters.mes = mes;
                        
                        // Update button states
                        document.querySelectorAll('.month-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        
                        const monthBtn = document.querySelector(`.month-btn[data-mes="${mes}"]`);
                        if (monthBtn) {
                            monthBtn.classList.add('active');
                        }
                        
                        this.filterData();
                    });
                });

                // Action buttons
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadRankingData();
                    this.showToast('Dados atualizados!', 'success');
                });

                document.getElementById('resetFilters').addEventListener('click', () => {
                    this.resetFilters();
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportToExcel();
                });

                document.getElementById('exportPDFBtn').addEventListener('click', () => {
                    this.exportToPDF();
                });

                document.getElementById('printBtn').addEventListener('click', () => {
                    window.print();
                });
            }

            checkAuth() {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        console.log("Usuário autenticado:", user.uid);
                        this.loadRankingData();
                    } else {
                        console.log("Redirecionando para login...");
                        window.location.href = '../index.html';
                    }
                });
            }

            async loadRankingData() {
                try {
                    this.showLoading();
                    
                    const snapshot = await firebase.firestore()
                        .collection('ranking-tst')
                        .orderBy('createdAt', 'desc')
                        .get();

                    if (snapshot.empty) {
                        this.showEmptyState();
                        return;
                    }

                    const registros = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        registros.push(data);
                    });

                    this.processRankingData(registros);
                    await this.loadTecnicoPhotos();
                    this.calculateStats();
                    this.filterData();
                    
                } catch (error) {
                    console.error('Erro ao carregar ranking:', error);
                    this.showError(error);
                }
            }

            processRankingData(registros) {
                const rankingPorTecnico = {};
                const anoAtual = parseInt(this.currentFilters.ano);
                
                registros.forEach(registro => {
                    const data = registro.dataHora ? registro.dataHora.toDate() : new Date();
                    const ano = data.getFullYear();
                    const mes = data.getMonth() + 1;
                    
                    if (ano !== anoAtual) return;
                    
                    const tecnicoId = registro.tecnicoId;
                    const tecnicoNome = registro.tecnicoNome || 'Técnico desconhecido';
                    const unidade = registro.unidade || 'Sem unidade';
                    
                    if (!rankingPorTecnico[tecnicoId]) {
                        rankingPorTecnico[tecnicoId] = {
                            tecnicoId: tecnicoId,
                            tecnicoNome: tecnicoNome,
                            unidade: unidade,
                            meses: Array(13).fill(0),
                            total: 0,
                            mesesComPontos: 0
                        };
                    }
                    
                    const pontosMes = registro.totalGeral || 0;
                    rankingPorTecnico[tecnicoId].meses[mes] = pontosMes;
                    rankingPorTecnico[tecnicoId].total += pontosMes;
                    
                    if (pontosMes > 0) {
                        rankingPorTecnico[tecnicoId].mesesComPontos++;
                    }
                    
                    if (unidade) this.unidadesDisponiveis.add(unidade);
                });

                this.dadosRanking = Object.values(rankingPorTecnico)
                    .sort((a, b) => b.total - a.total);

                this.populateUnitFilter();
            }

            async loadTecnicoPhotos() {
                try {
                    const tecnicosSnapshot = await firebase.firestore()
                        .collection('users')
                        .get();

                    tecnicosSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.photoBase64) {
                            this.tecnicoFotos[doc.id] = userData.photoBase64;
                        }
                    });
                } catch (error) {
                    console.error('Erro ao carregar fotos:', error);
                }
            }

            populateUnitFilter() {
                const filterUnidade = document.getElementById('filterUnidade');
                filterUnidade.innerHTML = '<option value="">Todas as unidades</option>';
                
                Array.from(this.unidadesDisponiveis).sort().forEach(unidade => {
                    const option = document.createElement('option');
                    option.value = unidade;
                    option.textContent = unidade;
                    filterUnidade.appendChild(option);
                });
            }

            filterData() {
                const { search, unidade, mes } = this.currentFilters;
                
                this.dadosFiltrados = this.dadosRanking.filter(tecnico => {
                    const nomeMatch = tecnico.tecnicoNome.toLowerCase().includes(search);
                    const unidadeMatch = !unidade || tecnico.unidade === unidade;
                    const mesMatch = !mes || tecnico.meses[mes] > 0;
                    
                    return nomeMatch && unidadeMatch && mesMatch;
                });

                this.sortData();
                this.renderTable();
                this.updateStats();
                this.updateFilterInfo();
            }

            sortData() {
                const { sortBy } = this.currentFilters;
                
                switch(sortBy) {
                    case 'nome':
                        this.dadosFiltrados.sort((a, b) => 
                            a.tecnicoNome.localeCompare(b.tecnicoNome)
                        );
                        break;
                    case 'unidade':
                        this.dadosFiltrados.sort((a, b) => {
                            const unidadeCompare = a.unidade.localeCompare(b.unidade);
                            return unidadeCompare !== 0 ? unidadeCompare : b.total - a.total;
                        });
                        break;
                    default:
                        this.dadosFiltrados.sort((a, b) => b.total - a.total);
                        break;
                }
            }

            renderTable() {
                const rankingBody = document.getElementById('rankingBody');
                
                if (this.dadosFiltrados.length === 0) {
                    this.showEmptyState();
                    return;
                }

                // Encontra o valor máximo para normalizar as barras de progresso
                const maxPontosMes = Math.max(
                    ...this.dadosFiltrados.flatMap(t => t.meses)
                );

                let html = '';

                this.dadosFiltrados.forEach((tecnico, index) => {
                    const posicao = index + 1;
                    const foto = this.tecnicoFotos[tecnico.tecnicoId];
                    const posicaoClass = this.getPositionClass(posicao);
                    
                    // Células dos meses
                    let celulasMeses = '';
                    for (let mes = 1; mes <= 12; mes++) {
                        const pontos = tecnico.meses[mes] || 0;
                        const isHighlight = this.currentFilters.mes === mes;
                        const progressoWidth = maxPontosMes > 0 ? (pontos / maxPontosMes) * 100 : 0;
                        
                        if (pontos > 0) {
                            celulasMeses += `
                                <td class="mes-cell ${isHighlight ? 'mes-destaque' : ''}">
                                    <div class="mes-valor">${pontos.toFixed(1)}</div>
                                    <div class="progresso-container">
                                        <div class="progresso-bar" style="width: ${progressoWidth}%"></div>
                                    </div>
                                </td>`;
                        } else {
                            celulasMeses += `
                                <td class="mes-cell">
                                    <div class="mes-sem-pontos">-</div>
                                </td>`;
                        }
                    }

                    html += `
                        <tr data-tecnico-id="${tecnico.tecnicoId}">
                            <td class="posicao-cell">
                                <div class="posicao-badge ${posicaoClass}">${posicao}</div>
                            </td>
                            <td>
                                <div class="tecnico-info">
                                    <div class="tecnico-foto-container">
                                        ${foto ? 
                                            `<img src="data:image/jpeg;base64,${foto}" class="tecnico-foto" alt="${tecnico.tecnicoNome}">` : 
                                            `<div class="foto-placeholder"><i class="fas fa-user"></i></div>`
                                        }
                                    </div>
                                    <div class="tecnico-detalhes">
                                        <div class="tecnico-nome">${tecnico.tecnicoNome}</div>
                                        <div class="tecnico-unidade">
                                            <i class="fas fa-building"></i> ${tecnico.unidade}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="pontos-total">${tecnico.total.toFixed(1)}</div>
                            </td>
                            ${celulasMeses}
                        </tr>`;
                });

                rankingBody.innerHTML = html;
            }

            getPositionClass(posicao) {
                switch(posicao) {
                    case 1: return 'posicao-1';
                    case 2: return 'posicao-2';
                    case 3: return 'posicao-3';
                    default: return 'posicao-outros';
                }
            }

            calculateStats() {
                if (this.dadosRanking.length === 0) return;
                
                const totalTecnicos = this.dadosRanking.length;
                const mediaPontos = this.dadosRanking.reduce((sum, t) => sum + t.total, 0) / totalTecnicos;
                const pontosMaximos = Math.max(...this.dadosRanking.map(t => t.total));
                
                // Conta meses ativos
                const mesesAtivos = new Set();
                this.dadosRanking.forEach(tecnico => {
                    tecnico.meses.forEach((pontos, mes) => {
                        if (pontos > 0) mesesAtivos.add(mes);
                    });
                });

                // Atualiza cards do dashboard
                document.getElementById('totalTecnicos').textContent = totalTecnicos;
                document.getElementById('mediaPontos').textContent = mediaPontos.toFixed(1);
                document.getElementById('liderAtual').textContent = this.dadosRanking[0]?.tecnicoNome.split(' ')[0] || '-';
                document.getElementById('pontosLider').textContent = this.dadosRanking[0]?.total.toFixed(1) + ' pontos';
                document.getElementById('mesesAtivos').textContent = `${mesesAtivos.size - 1}/12`;

                // Atualiza estatísticas do header
                this.updateHeaderStats(totalTecnicos, mediaPontos, pontosMaximos, this.unidadesDisponiveis.size);
            }

            updateStats() {
                if (this.dadosFiltrados.length === 0) return;
                
                const mediaFiltrada = this.dadosFiltrados.reduce((sum, t) => sum + t.total, 0) / this.dadosFiltrados.length;
                document.getElementById('mediaPontos').textContent = mediaFiltrada.toFixed(1);
                
                if (this.dadosFiltrados.length > 0) {
                    document.getElementById('liderAtual').textContent = this.dadosFiltrados[0].tecnicoNome.split(' ')[0];
                    document.getElementById('pontosLider').textContent = this.dadosFiltrados[0].total.toFixed(1) + ' pontos';
                }
            }

            updateHeaderStats(totalTecnicos, mediaPontos, pontosMaximos, unidades) {
                const headerStats = document.getElementById('headerStats');
                headerStats.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${totalTecnicos}</div>
                        <div class="stat-label">Técnicos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${mediaPontos.toFixed(1)}</div>
                        <div class="stat-label">Média de Pontos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${pontosMaximos.toFixed(1)}</div>
                        <div class="stat-label">Pontuação Máxima</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${unidades}</div>
                        <div class="stat-label">Unidades</div>
                    </div>
                `;
            }

            updateFilterInfo() {
                document.getElementById('filterCount').textContent = this.dadosFiltrados.length;
                document.getElementById('totalCount').textContent = this.dadosRanking.length;
            }

            resetFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('filterUnidade').value = '';
                document.getElementById('sortBy').value = 'total';
                
                // Reset month buttons
                document.querySelectorAll('.month-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.month-btn[data-mes="0"]').classList.add('active');
                
                this.currentFilters = {
                    search: '',
                    unidade: '',
                    ano: this.currentFilters.ano,
                    mes: 0,
                    sortBy: 'total'
                };
                
                this.filterData();
                this.showToast('Filtros resetados!', 'info');
            }

            exportToExcel() {
                try {
                    // Prepara dados
                    const wsData = [
                        ['Mapa de Perfomance'],
                        [`Ano: ${this.currentFilters.ano}`, '', '', `Data: ${new Date().toLocaleDateString()}`],
                        [''],
                        ['Posição', 'Nome do Técnico', 'Unidade', 'Pontos Totais', 
                         'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                         'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']
                    ];

                    this.dadosFiltrados.forEach((tecnico, index) => {
                        const row = [
                            index + 1,
                            tecnico.tecnicoNome,
                            tecnico.unidade,
                            tecnico.total.toFixed(1)
                        ];

                        for (let mes = 1; mes <= 12; mes++) {
                            row.push(tecnico.meses[mes] ? tecnico.meses[mes].toFixed(1) : '-');
                        }

                        wsData.push(row);
                    });

                    // Cria planilha
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Ranking TST");

                    // Exporta
                    const fileName = `ranking_tst_${this.currentFilters.ano}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    this.showToast('Excel exportado com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro ao exportar Excel:', error);
                    this.showToast('Erro ao exportar: ' + error.message, 'error');
                }
            }

            exportToPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.text('Mapa de Perfomance', 14, 20);
                    
                    // Subtítulo
                    doc.setFontSize(11);
                    doc.text(`Ano: ${this.currentFilters.ano} | Exportado em: ${new Date().toLocaleDateString()}`, 14, 28);
                    
                    // Tabela
                    const tableData = this.dadosFiltrados.map((tecnico, index) => {
                        const row = [
                            index + 1,
                            tecnico.tecnicoNome,
                            tecnico.unidade,
                            tecnico.total.toFixed(1)
                        ];
                        
                        for (let mes = 1; mes <= 12; mes++) {
                            row.push(tecnico.meses[mes] ? tecnico.meses[mes].toFixed(1) : '-');
                        }
                        
                        return row;
                    });
                    
                    const headers = [
                        '#', 'Técnico', 'Unidade', 'Total',
                        'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                        'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
                    ];
                    
                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: 35,
                        theme: 'grid',
                        headStyles: { fillColor: [26, 95, 122] },
                        margin: { top: 35 }
                    });
                    
                    // Salva
                    const fileName = `ranking_tst_${this.currentFilters.ano}.pdf`;
                    doc.save(fileName);
                    
                    this.showToast('PDF exportado com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao exportar PDF:', error);
                    this.showToast('Erro ao exportar PDF', 'error');
                }
            }

            showLoading() {
                document.getElementById('rankingBody').innerHTML = `
                    <tr>
                        <td colspan="15">
                            <div class="loading-state">
                                <div class="spinner"></div>
                                <p>Carregando dados do ranking...</p>
                            </div>
                        </td>
                    </tr>`;
            }

            showEmptyState() {
                document.getElementById('rankingBody').innerHTML = `
                    <tr>
                        <td colspan="15">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <h4 class="empty-title">Nenhum dado encontrado</h4>
                                <p class="empty-text">Não há registros para os filtros selecionados. Tente ajustar os filtros ou carregar dados de outro ano.</p>
                                <button class="btn btn-primary mt-3" onclick="app.resetFilters()">
                                    <i class="fas fa-redo"></i> Limpar Filtros
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }

            showError(error) {
                document.getElementById('rankingBody').innerHTML = `
                    <tr>
                        <td colspan="15">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h4 class="empty-title">Erro ao carregar dados</h4>
                                <p class="empty-text">${error.message || 'Ocorreu um erro ao carregar os dados.'}</p>
                                <button class="btn btn-primary mt-3" onclick="app.loadRankingData()">
                                    <i class="fas fa-sync-alt"></i> Tentar Novamente
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }

            showToast(message, type = 'info') {
                const backgroundColor = {
                    success: '#28a745',
                    error: '#dc3545',
                    warning: '#fd7e14',
                    info: '#1a5f7a'
                }[type];

                Toastify({
                    text: message,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: backgroundColor,
                    stopOnFocus: true,
                    className: "toast-message"
                }).showToast();
            }
        }

        // Inicializa a aplicação
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new RankingApp();
        });
    </script>
</body>
</html>