<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Segurança do Trabalho</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="img/engenheiro.png" type="image/x-icon">
</head>
<body>
    <div class="auth-container" id="login-container">
        <div class="auth-box">
            <div class="logo-container">

                <div class="partner-logos">
                    <img src="images/nr-logo.png" alt="Normas Regulamentadoras" class="partner-logo" onerror="this.style.display='none'">
                    <img src="images/epi-logo.png" alt="EPIs" class="partner-logo" onerror="this.style.display='none'">
                    <img src="images/sst-logo.png" alt="SST" class="partner-logo" onerror="this.style.display='none'">
                </div>
            </div>
            
            <div class="auth-header">
                <h2>Bem-vindo ao Sistema de SST</h2>
                <p>Faça login para acessar o sistema de Segurança do Trabalho</p>
            </div>
            
            <div class="form-container">
                <div id="login-message" class="alert hidden"></div>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" class="form-control" placeholder="seu@email.com" required>
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Senha</label>
                        <input type="password" id="login-password" class="form-control" placeholder="••••••••" required>
                        <i class="fas fa-lock input-icon"></i>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('login-password', this)"></i>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn" id="login-btn">
                            <span class="btn-text">Entrar</span>
                            <span class="fa fa-spinner hidden"></span>
                        </button>
                    </div>
                    
                    <div class="auth-footer">
                        <a href="#" id="forgot-password-link">Esqueceu sua senha?</a> | 
                        <a href="#" id="show-register-link">Criar uma conta</a>
                    </div>
                </form>
                
                <div class="safety-elements">
                    <i class="fas fa-hard-hat safety-icon" title="Capacete de Segurança"></i>
                    <i class="fas fa-vest safety-icon" title="Colete Refletivo"></i>
                    <i class="fas fa-mask safety-icon" title="Máscara de Proteção"></i>
                    <i class="fas fa-goggles safety-icon" title="Óculos de Proteção"></i>
                    <i class="fas fa-hand-paper safety-icon" title="Luvas de Proteção"></i>
                    <i class="fas fa-shoe-prints safety-icon" title="Botinas de Segurança"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="auth-container hidden" id="register-container">
        <div class="auth-box">

            <div class="auth-header">
                <h2>Criar conta</h2>
                <p>Preencha os dados para se registrar no sistema de SST</p>
            </div>
            
            <div class="form-container">
                <div id="register-message" class="alert hidden"></div>
                
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">Nome completo</label>
                        <input type="text" id="register-name" class="form-control" placeholder="Seu nome completo" required>
                        <i class="fas fa-user input-icon"></i>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" class="form-control" placeholder="seu@email.com" required>
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password">Senha</label>
                        <input type="password" id="register-password" class="form-control" placeholder="••••••••" required minlength="6">
                        <i class="fas fa-lock input-icon"></i>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('register-password', this)"></i>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-confirm-password">Confirmar senha</label>
                        <input type="password" id="register-confirm-password" class="form-control" placeholder="••••••••" required minlength="6">
                        <i class="fas fa-lock input-icon"></i>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('register-confirm-password', this)"></i>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-unit">Unidade</label>
                        <select id="register-unit" class="select-unit" required>
                            <option value="" disabled selected>Selecione sua unidade</option>
                            <option value="CD-TZK-SZN">CD-TZK-SZN</option>
                                <option value="CD-TRI-GRU">CD-TRI-GRU</option>
                                <option value="F-WBR-MCZ">F-WBR-MCZ</option>
                                <option value="ITM-SP">ITM-SP</option>
                                <option value="F-NTR-MCZ">F-NTR-MCZ</option>
                                <option value="CD-YMH-SP">CD-YMH-SP</option>
                                <option value="F-AST-SCI">F-AST-SCI</option>
                                <option value="F-JD-CAS">F-JD-CAS</option>
                                <option value="F-JD-CTL">F-JD-CTL</option>
                                <option value="F-JD-HZA">F-JD-HZA</option>
                                <option value="F-JD-IDU">F-JD-IDU</option>
                                <option value="F-JD-MGO">F-JD-MGO</option>
                                <option value="F-OJI-PAA">F-OJI-PAA</option>
                                <option value="F-OJI-RCA">F-OJI-RCA</option>
                                <option value="CD-SZL-SZN">CD-SZL-SZN</option>
                                <option value="CD-SZN-SZN">CD-SZN-SZN</option>
                                <option value="F-SRV-SZN">F-SRV-SZN</option>
                                <option value="F-SZN-SZN">F-SZN-SZN</option>
                                <option value="F-SZN-BLM">F-SZN-BLM</option>
                                <option value="F-SZN-IMP">F-SZN-IMP</option>
                                <option value="CD-SZN-MCW">CD-SZN-MCW</option>
                                <option value="F-IMS-LRA">F-IMS-LRA</option>
                                <option value="F-PAP-LRA">F-PAP-LRA</option>
                                <option value="F-SZN-LRA">F-SZN-LRA</option>
                                <option value="F-SZN-CPO">F-SZN-CPO</option>
                                <option value="F-BTK-SRQ">F-BTK-SRQ</option>
                                <option value="F-IBM-EMB">F-IBM-EMB</option>
                                <option value="F-WBR-JAD">F-WBR-JAD</option>
                                <option value="ADM-MTZ-MCZ">ADM-MTZ-MCZ</option>
                                <option value="F-WTM-JCI">F-WTM-JCI</option>
                                <option value="F-YHM-SP">F-YHM-SP</option>
                                <option value="CD-SZN-CPO">CD-SZN-CPO</option>
                                <option value="CD-SZN-SJP">CD-SZN-SJP</option>
                                <option value="F-PCO-MCZ">F-PCO-MCZ</option>
                                <option value="CD-SZN-CCA">CD-SZN-CCA</option>
                                <option value="CD-SZN-SEA">CD-SZN-SEA</option>
                                <option value="MATRIZ-ES">MATRIZ-ES</option>
                                <option value="F-PCO-FSA">F-PCO-FSA</option>
                                <option value="F-WBR-CAR">F-WBR-CAR</option>
                                <option value="CD-SZN-CAS">CD-SZN-CAS</option>
                                <option value="F-IMS-CIM">F-IMS-CIM</option>
                                <option value="F-SZN-ACZ">F-SZN-ACZ</option>
                                <option value="F-SZN-MCZ">F-SZN-MCZ</option>
                        </select>
                        <i class="fas fa-building input-icon"></i>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-role">Função</label>
                        <select id="register-role" class="select-unit" required>
                            <option value="" disabled selected>Selecione sua função</option>
                            <option value="sst">Técnico de Segurança</option>
                            <option value="worker">Trabalhador</option>
                            <option value="manager">Gestor</option>
                            <option value="visitor">Visitante</option>
                        </select>
                        <i class="fas fa-user-tie input-icon"></i>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn" id="register-btn">
                            <span class="btn-text">Registrar</span>
                            <span class="fa fa-spinner hidden"></span>
                        </button>
                    </div>
                    
                    <div class="form-switch">
                        Já tem uma conta? <a href="#" id="show-login-link">Faça login</a>
                    </div>
                </form>
                
                <div class="safety-elements">
                    <i class="fas fa-exclamation-triangle safety-icon" title="Área de Risco"></i>
                    <i class="fas fa-biohazard safety-icon" title="Risco Biológico"></i>
                    <i class="fas fa-fire-extinguisher safety-icon" title="Extintor"></i>
                    <i class="fas fa-first-aid safety-icon" title="Primeiros Socorros"></i>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDZwa4XNqlupNDLs7-CRQbhr5pRT4NyFBA",
  authDomain: "application-gzl.firebaseapp.com",
  databaseURL: "https://application-gzl-default-rtdb.firebaseio.com",
  projectId: "application-gzl",
  storageBucket: "application-gzl.appspot.com",
  messagingSenderId: "319900903265",
  appId: "1:319900903265:web:a8f400aeb7a697fc168720",
  measurementId: "G-ZRRFQZXT54"
};

// Inicializa o Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Verifica se está na página de login ou home
const isLoginPage = window.location.pathname.includes('index.html') || 
                    window.location.pathname === '/' || 
                    window.location.pathname === '/index.html';

const isHomePage = window.location.pathname.includes('home.html');

// Funções compartilhadas
function showMessage(elementId, message, type) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.classList.remove('hidden', 'alert-success', 'alert-danger', 'alert-warning');
        element.classList.add(`alert-${type}`, 'show');
        
        setTimeout(() => {
            element.classList.remove('show');
            setTimeout(() => element.classList.add('hidden'), 500);
        }, 5000);
    }
}

function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
}

function toggleLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    if (button) {
        const spinner = button.querySelector('.fa-spinner');
        const buttonText = button.querySelector('.btn-text');
        
        if (isLoading) {
            button.disabled = true;
            spinner.classList.remove('hidden');
            if (buttonText) buttonText.classList.add('hidden');
        } else {
            button.disabled = false;
            spinner.classList.add('hidden');
            if (buttonText) buttonText.classList.remove('hidden');
        }
    }
}

function toggleAuthForms() {
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    
    if (loginContainer.classList.contains('hidden')) {
        loginContainer.classList.remove('hidden');
        registerContainer.classList.add('hidden');
    } else {
        loginContainer.classList.add('hidden');
        registerContainer.classList.remove('hidden');
    }
}

// Lógica da página de login
if (isLoginPage) {
    // Alternar entre login e registro
    document.getElementById('show-register-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthForms();
        
        // Preenche o email se já estiver preenchido no login
        const loginEmail = document.getElementById('login-email').value;
        if (loginEmail) {
            document.getElementById('register-email').value = loginEmail;
        }
    });
    
    document.getElementById('show-login-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthForms();
    });

    // Login com email e senha
    document.getElementById('login-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        toggleLoading('login-btn', true);
        
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Atualiza o último login no Firestore
                return db.collection('users').doc(userCredential.user.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            })
            .then(() => {
                window.location.href = 'home.html';
            })
            .catch((error) => {
                let errorMessage = error.message;
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuário não encontrado. Verifique o email ou crie uma conta.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Senha incorreta. Tente novamente ou clique em "Esqueceu sua senha?"';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Muitas tentativas falhas. Acesso temporariamente bloqueado. Tente mais tarde ou redefina sua senha.';
                }
                showMessage('login-message', errorMessage, 'danger');
            })
            .finally(() => {
                toggleLoading('login-btn', false);
            });
    });

    // Recuperação de senha
    document.getElementById('forgot-password-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        
        if (!email) {
            showMessage('login-message', 'Digite seu email para redefinir a senha', 'warning');
            return;
        }
        
        toggleLoading('login-btn', true);
        
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showMessage('login-message', `Email de redefinição enviado para ${email}. Verifique sua caixa de entrada.`, 'success');
            })
            .catch((error) => {
                let errorMessage = error.message;
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Email não cadastrado. Crie uma conta primeiro.';
                }
                showMessage('login-message', errorMessage, 'danger');
            })
            .finally(() => {
                toggleLoading('login-btn', false);
            });
    });

    // Registro de nova conta
    document.getElementById('register-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        const unit = document.getElementById('register-unit').value;
        
        // Validações
        if (password !== confirmPassword) {
            showMessage('register-message', 'As senhas não coincidem', 'danger');
            return;
        }
        
        if (password.length < 6) {
            showMessage('register-message', 'A senha deve ter pelo menos 6 caracteres', 'danger');
            return;
        }
        
        if (!unit) {
            showMessage('register-message', 'Selecione uma unidade', 'danger');
            return;
        }
        
        toggleLoading('register-btn', true);
        
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Salva informações adicionais no Firestore
                return db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    unit: unit,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'user'
                });
            })
            .then(() => {
                showMessage('register-message', 'Conta criada com sucesso! Redirecionando...', 'success');
                setTimeout(() => window.location.href = 'home.html', 2000);
            })
            .catch((error) => {
                let errorMessage = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email já cadastrado. Faça login ou use outro email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inválido. Digite um email válido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Senha muito fraca. Use uma senha mais complexa.';
                }
                showMessage('register-message', errorMessage, 'danger');
            })
            .finally(() => {
                toggleLoading('register-btn', false);
            });
    });
}

// Lógica da página home
if (isHomePage) {
    const loadUserData = (user) => {
        db.collection('users').doc(user.uid).get()
            .then((doc) => {
                if (!doc.exists) {
                    console.log("Documento do usuário não encontrado");
                    return;
                }
                
                const userData = doc.data();
                
                // Atualiza a interface
                document.getElementById('sidebar-user-name').textContent =
                    userData?.name || user.displayName || "Usuário";
                document.getElementById('home-user-unit').textContent = 
                    userData?.unit || "Não definida";
                document.getElementById('home-user-unit-detail').textContent = 
                    userData?.unit || "Não definida";
                document.getElementById('home-user-email').textContent = user.email;
                
                if (userData?.createdAt) {
                    const date = userData.createdAt.toDate();
                    document.getElementById('home-user-created-at').textContent = 
                        date.toLocaleDateString('pt-BR') + ' às ' + date.toLocaleTimeString('pt-BR');
                }
                
                if (userData?.lastLogin) {
                    const lastLoginDate = userData.lastLogin.toDate();
                    document.getElementById('home-user-last-login').textContent = 
                        lastLoginDate.toLocaleDateString('pt-BR') + ' às ' + lastLoginDate.toLocaleTimeString('pt-BR');
                }
            })
            .catch((error) => {
                console.log("Erro ao carregar dados:", error);
                document.getElementById('home-user-name').textContent = 
                    user.displayName || "Usuário";
                document.getElementById('home-user-unit').textContent = "Não definida";
                document.getElementById('home-user-email').textContent = user.email;
            });
    };

    // Logout
    document.getElementById('sidebar-logout-btn')?.addEventListener('click', logoutUser);

    // Verifica autenticação ao carregar a home
    auth.onAuthStateChanged((user) => {
        if (user) {
            loadUserData(user);
        } else {
            window.location.href = 'index.html';
        }
    });
}
function logoutUser() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Erro ao fazer logout:', error);
            });
        }
    </script>
</body>
</html>